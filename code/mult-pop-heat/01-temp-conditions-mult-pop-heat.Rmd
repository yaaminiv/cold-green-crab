---
title: "01-temp-conditions"
author: "Yaamini Venkataraman"
date: "4/2/2025"
output: html_document
---

# Set up R Markdown document

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../../output/mult-pop-heat/01-temp-conditions/")) #Set root directory
```

```{r}
getwd()
```

#Install packages

```{r}
#install.packages("tidyverse")
#install.packages("data.table)
#install.packages("RColorBrewer")
#install.packages("patchwork")
require(tidyverse)
require(data.table)
require(RColorBrewer)
require(patchwork)
```

```{r}
sessionInfo()
```
# WA

## Import and format data

Outliers from when HOBO loggers recorded data while outside of the tank were removed manually.

```{r}
#Import CSV output from HOBO loggers. Skip first line of CSV and specify header. Retain second and third columns, rename columns, and format dateTime column correctly

tank1aWA <- read.csv("../../../data/mult-pop-heat/HOBO/WA_T1A.csv", skip = 1, header = TRUE) %>% dplyr::select(., 2:3) %>% rename(dateTime = Date.Time..GMT.04.00, temp1a = Temp...C..LGR.S.N..20548771..SEN.S.N..20548771.)  %>% mutate(dateTime = as.POSIXct(dateTime, format = "%m/%d/%y%t%H:%M"))
tank1bWA <- read.csv("../../../data/mult-pop-heat/HOBO/WA_T1B.csv", skip = 1, header = TRUE) %>% dplyr::select(., 2:3) %>% rename(dateTime = Date.Time..GMT.04.00, temp1b = Temp...C..LGR.S.N..21435406..SEN.S.N..21435406.) %>% mutate(dateTime = as.POSIXct(dateTime, format = "%m/%d/%y%t%H:%M"))

tank2aWA <- read.csv("../../../data/mult-pop-heat/HOBO/WA_T2A.csv", skip = 1, header = TRUE) %>% dplyr::select(., 2:3) %>% rename(dateTime = Date.Time..GMT.04.00, temp2a = Temp...C..LGR.S.N..20548772..SEN.S.N..20548772.) %>% mutate(dateTime = as.POSIXct(dateTime, format = "%m/%d/%y%t%H:%M"))
tank2bWA <- read.csv("../../../data/mult-pop-heat/HOBO/WA_T2B.csv", skip = 1, header = TRUE) %>% dplyr::select(., 2:3) %>% rename(dateTime = Date.Time..GMT.04.00, temp2b = Temp...C..LGR.S.N..20239628..SEN.S.N..20239628.) %>% mutate(dateTime = as.POSIXct(dateTime, format = "%m/%d/%y%t%H:%M"))
```

```{r}
#Add columns for tank ID and treatment

tank1aWA <- tank1aWA %>% 
  mutate(., tank = 1)
tank1bWA <- tank1bWA %>% 
  mutate(., tank = 1)

tank2aWA <- tank2aWA %>% 
  mutate(., tank = 2)
tank2bWA <- tank2bWA %>% 
  mutate(., tank = 2)
```

```{r}
tempCleanWA <- cbind(tank1aWA, tank1bWA,
                   tank2aWA, tank2bWA) %>%
  dplyr::select(c(1, 
                  2, 5,
                  8, 11)) #cbind data and select necessary columns
head(tempCleanWA) #Confirm changes
```

## Calculate treatment conditions

### For each tank

```{r}
treatmentTempStatsWA <- data.frame("tank" = c(1:2),
                                 "meanTemp" = rep(0, times = 2),
                                 "sdTemp" = rep(0, times = 2)) #Create an empty dataframe
treatmentTempStatsWA #Confirm dataframe creation
```

```{r}
for (i in seq(2, 4, 2)) {
  treatmentTempStatsWA[(i/2),2] <-
    mean(rbind(tempCleanWA[[i]], 
               tempCleanWA[[i+1]]), na.rm = TRUE)
  treatmentTempStatsWA[(i/2),3] <-
    sd(rbind(tempCleanWA[[i]], 
             tempCleanWA[[i+1]]), na.rm = TRUE)
} #For each tank, combine the treatment temperature data from both HOBO loggers, either find the average or SD, and save in treatmentTempStats
head(treatmentTempStatsWA) #Confirm calculations
```

```{r}
write.csv(treatmentTempStatsWA, "temp-mean-sd-WA.csv", quote = FALSE)
```

### Overall conditions

```{r}
rbind(tempCleanWA$temp1a,
      tempCleanWA$temp1b,
      tempCleanWA$temp2a,
      tempCleanWA$temp2b) %>%
  mean(.) #Mean = 30.07167
rbind(tempCleanWA$temp1a,
      tempCleanWA$temp1b,
      tempCleanWA$temp2a,
      tempCleanWA$temp2b) %>%
  sd(.) #Mean = 0.2188562
```

## Statistical test

I will use a Kruskal-Wallis to confirm there are significant differences between tanks.

### Format data

```{r}
tempLongWA <- tempCleanWA %>%
  pivot_longer(., cols = temp1a:temp2b, values_to = "temperature", names_to = "logger") %>%
  mutate(., tank = case_when(logger == "temp1a" | logger == "temp1b" ~ "tank1",
                             logger == "temp2a" | logger == "temp2b" ~ "tank2")) %>%
  dplyr::select(-logger) %>% 
  drop_na()
head(tempLongWA)
```

### Perform Kruskal-Wallis tests

```{r}
tempLongStatsWA <- kruskal.test(temperature ~ tank, data = tempLongWA)
tempLongStatsWA #Significant differences between treatments.

broom::tidy(tempLongStatsWA) #Chi-sq: 166.9319, p = 3.461811e-38
```

# ME

## Import and format data

Outliers from when HOBO loggers recorded data while outside of the tank were removed manually.

```{r}
#Import CSV output from HOBO loggers. Skip first line of CSV and specify header. Retain second and third columns, rename columns, and format dateTime column correctly

tank1aME <- read.csv("../../../data/mult-pop-heat/HOBO/ME_T1A.csv", skip = 1, header = TRUE) %>% dplyr::select(., 2:3) %>% rename(dateTime = Date.Time..GMT.04.00, temp1a = Temp...C..LGR.S.N..20548771..SEN.S.N..20548771.)  %>% mutate(dateTime = as.POSIXct(dateTime, format = "%m/%d/%y%t%H:%M"))
tank1bME <- read.csv("../../../data/mult-pop-heat/HOBO/ME_T1B.csv", skip = 1, header = TRUE) %>% dplyr::select(., 2:3) %>% rename(dateTime = Date.Time..GMT.04.00, temp1b = Temp...C..LGR.S.N..21435406..SEN.S.N..21435406.) %>% mutate(dateTime = as.POSIXct(dateTime, format = "%m/%d/%y%t%H:%M"))

tank2aME <- read.csv("../../../data/mult-pop-heat/HOBO/ME_T2A.csv", skip = 1, header = TRUE) %>% dplyr::select(., 2:3) %>% rename(dateTime = Date.Time..GMT.04.00, temp2a = Temp...C..LGR.S.N..20548772..SEN.S.N..20548772.) %>% mutate(dateTime = as.POSIXct(dateTime, format = "%m/%d/%y%t%H:%M"))
tank2bME <- read.csv("../../../data/mult-pop-heat/HOBO/ME_T2B.csv", skip = 1, header = TRUE) %>% dplyr::select(., 2:3) %>% rename(dateTime = Date.Time..GMT.04.00, temp2b = Temp...C..LGR.S.N..20239628..SEN.S.N..20239628.) %>% mutate(dateTime = as.POSIXct(dateTime, format = "%m/%d/%y%t%H:%M"))
```

```{r}
#Add columns for tank ID and treatment

tank1aME <- tank1aME %>% 
  mutate(., tank = 1) %>%
  slice(., -276)
tank1bME <- tank1bME %>% 
  mutate(., tank = 1) %>%
  slice(., -276)

tank2aME <- tank2aME %>% 
  mutate(., tank = 2)
tank2bME <- tank2bME %>% 
  mutate(., tank = 2)
```

```{r}
tempCleanME <- cbind(tank1aME, tank1bME,
                   tank2aME, tank2bME) %>%
  dplyr::select(c(1, 
                  2, 5,
                  8, 11)) #cbind data and select necessary columns
head(tempCleanME) #Confirm changes
```

## Calculate treatment conditions

### For each tank

```{r}
treatmentTempStatsME <- data.frame("tank" = c(1:2),
                                 "meanTemp" = rep(0, times = 2),
                                 "sdTemp" = rep(0, times = 2)) #Create an empty dataframe
treatmentTempStatsME #Confirm dataframe creation
```

```{r}
for (i in seq(2, 4, 2)) {
  treatmentTempStatsME[(i/2),2] <-
    mean(rbind(tempCleanME[[i]][-c(1:184)], 
               tempCleanME[[i+1]][-c(1:184)]), na.rm = TRUE)
  treatmentTempStatsME[(i/2),3] <-
    sd(rbind(tempCleanME[[i]][-c(1:184)], 
             tempCleanME[[i+1]][-c(1:184)]), na.rm = TRUE)
} #For each tank, combine the treatment temperature data from both HOBO loggers, either find the average or SD, and save in treatmentTempStats.
head(treatmentTempStatsME) #Confirm calculations
```

```{r}
write.csv(treatmentTempStatsME, "temp-mean-sd-ME.csv", quote = FALSE)
```

### Overall conditions

```{r}
rbind(tempCleanME$temp1a[-c(1:184)],
      tempCleanME$temp1b[-c(1:184)],
      tempCleanME$temp2a[-c(1:184)],
      tempCleanME$temp2b[-c(1:184)]) %>%
  mean(.) #Mean = 29.91406
rbind(tempCleanME$temp1a[-c(1:184)],
      tempCleanME$temp1b[-c(1:184)],
      tempCleanME$temp2a[-c(1:184)],
      tempCleanME$temp2b[-c(1:184)]) %>%
  sd(.) #Mean = 0.3027249
```

## Statistical test

I will use a Kruskal-Wallis to confirm there are significant differences between tanks.

### Format data

```{r}
tempLongME <- tempCleanME %>%
  slice(-c(1:184)) %>%
  pivot_longer(., cols = temp1a:temp2b, values_to = "temperature", names_to = "logger") %>%
  mutate(., tank = case_when(logger == "temp1a" | logger == "temp1b" ~ "tank1",
                             logger == "temp2a" | logger == "temp2b" ~ "tank2")) %>%
  dplyr::select(-logger) %>% 
  drop_na()
head(tempLongME)
```

### Perform Kruskal-Wallis tests

```{r}
tempLongStatsME <- kruskal.test(temperature ~ tank, data = tempLongME)
tempLongStatsME #Significant differences between treatments.

broom::tidy(tempLongStatsME) #Chi-sq: 264.8512, p = 1.503481e-59
```

# NH

## Import and format data

Outliers from when HOBO loggers recorded data while outside of the tank were removed manually.

```{r}
#Import CSV output from HOBO loggers. Skip first line of CSV and specify header. Retain second and third columns, rename columns, and format dateTime column correctly

tank1aNH <- read.csv("../../../data/mult-pop-heat/HOBO/NH_T1A.csv", skip = 1, header = TRUE) %>% dplyr::select(., 2:3) %>% rename(dateTime = Date.Time..GMT.04.00, temp1a = Temp...C..LGR.S.N..20548771..SEN.S.N..20548771.)  %>% mutate(dateTime = as.POSIXct(dateTime, format = "%m/%d/%y%t%H:%M"))
tank1bNH <- read.csv("../../../data/mult-pop-heat/HOBO/NH_T1B.csv", skip = 1, header = TRUE) %>% dplyr::select(., 2:3) %>% rename(dateTime = Date.Time..GMT.04.00, temp1b = Temp...C..LGR.S.N..21435406..SEN.S.N..21435406.) %>% mutate(dateTime = as.POSIXct(dateTime, format = "%m/%d/%y%t%H:%M"))

tank2aNH <- read.csv("../../../data/mult-pop-heat/HOBO/NH_T2A.csv", skip = 1, header = TRUE) %>% dplyr::select(., 2:3) %>% rename(dateTime = Date.Time..GMT.04.00, temp2a = Temp...C..LGR.S.N..20548772..SEN.S.N..20548772.) %>% mutate(dateTime = as.POSIXct(dateTime, format = "%m/%d/%y%t%H:%M"))
tank2bNH <- read.csv("../../../data/mult-pop-heat/HOBO/NH_T2B.csv", skip = 1, header = TRUE) %>% dplyr::select(., 2:3) %>% rename(dateTime = Date.Time..GMT.04.00, temp2b = Temp...C..LGR.S.N..20239628..SEN.S.N..20239628.) %>% mutate(dateTime = as.POSIXct(dateTime, format = "%m/%d/%y%t%H:%M"))
```

```{r}
#Add columns for tank ID and treatment

tank1aNH <- tank1aNH %>% 
  mutate(., tank = 1) %>%
  slice(., -276)
tank1bNH <- tank1bNH %>% 
  mutate(., tank = 1) %>%
  slice(., -276)

tank2aNH <- tank2aNH %>% 
  mutate(., tank = 2)
tank2bNH <- tank2bNH %>% 
  mutate(., tank = 2)
```

```{r}
tempCleanNH <- cbind(tank1aNH, tank1bNH,
                   tank2aNH, tank2bNH) %>%
  dplyr::select(c(1, 
                  2, 5,
                  8, 11)) #cbind data and select necessary columns
head(tempCleanNH) #Confirm changes
```

## Calculate treatment conditions

### For each tank

```{r}
treatmentTempStatsNH <- data.frame("tank" = c(1:2),
                                 "meanTemp" = rep(0, times = 2),
                                 "sdTemp" = rep(0, times = 2)) #Create an empty dataframe
treatmentTempStatsNH #Confirm dataframe creation
```

```{r}
for (i in seq(2, 4, 2)) {
  treatmentTempStatsNH[(i/2),2] <-
    mean(rbind(tempCleanNH[[i]][-c(1:184)], 
               tempCleanNH[[i+1]][-c(1:184)]), na.rm = TRUE)
  treatmentTempStatsNH[(i/2),3] <-
    sd(rbind(tempCleanNH[[i]][-c(1:184)], 
             tempCleanNH[[i+1]][-c(1:184)]), na.rm = TRUE)
} #For each tank, combine the treatment temperature data from both HOBO loggers, either find the average or SD, and save in treatmentTempStats.
head(treatmentTempStatsNH) #Confirm calculations
```

```{r}
write.csv(treatmentTempStatsNH, "temp-mean-sd-NH.csv", quote = FALSE)
```

### Overall conditions

```{r}
rbind(tempCleanNH$temp1a[-c(1:184)],
      tempCleanNH$temp1b[-c(1:184)],
      tempCleanNH$temp2a[-c(1:184)],
      tempCleanNH$temp2b[-c(1:184)]) %>%
  mean(.) #Mean = 29.91406
rbind(tempCleanNH$temp1a[-c(1:184)],
      tempCleanNH$temp1b[-c(1:184)],
      tempCleanNH$temp2a[-c(1:184)],
      tempCleanNH$temp2b[-c(1:184)]) %>%
  sd(.) #Mean = 0.3027249
```

## Statistical test

I will use a Kruskal-Wallis to confirm there are significant differences between tanks.

### Format data

```{r}
tempLongNH <- tempCleanNH %>%
  slice(-c(1:184)) %>%
  pivot_longer(., cols = temp1a:temp2b, values_to = "temperature", names_to = "logger") %>%
  mutate(., tank = case_when(logger == "temp1a" | logger == "temp1b" ~ "tank1",
                             logger == "temp2a" | logger == "temp2b" ~ "tank2")) %>%
  dplyr::select(-logger) %>% 
  drop_na()
head(tempLongNH)
```

### Perform Kruskal-Wallis tests

```{r}
tempLongStatsNH <- kruskal.test(temperature ~ tank, data = tempLongNH)
tempLongStatsNH #Significant differences between treatments.

broom::tidy(tempLongStatsNH) #Chi-sq: 264.8512, p = 1.503481e-59
```



# Plot full temperature conditions

```{bash}
mkdir figures
```

```{r}
plotColors <- c(brewer.pal(9, "Reds")[7],
                brewer.pal(9, "Greys")[7]) #Create color scheme
```

```{r}
tempClean[4:395,] %>%
  dplyr::select(dateTime, 
                temp10a, temp10b,
                temp11a, temp11b,
                temp12a, temp12b, 
                temp13a, temp13b) %>%
  rowwise() %>%
  mutate(., controlTemp = mean(c(temp10a, temp10b,
                                 temp12a, temp12b), na.rm = TRUE),
         treatmentTemp = mean(c(temp11a, temp11b,
                                temp13a, temp13b), na.rm = TRUE)) %>%
  ggplot(., aes(x = dateTime, y = treatmentTemp)) +
  geom_line(color = plotColors[1]) + #Average treatment temperature
  geom_segment(aes(x = tempClean$dateTime[31], xend = tempClean$dateTime[108], 
                   y = treatmentTempStatsOverall$meanTempPulse1[2], yend = treatmentTempStatsOverall$meanTempPulse1[2]), 
               color = plotColors[1], linetype = 3) + #Pulse 1 treatment segment
  geom_ribbon(data = tempClean[31:108], 
              aes(x = dateTime, 
                  y = treatmentTempStatsOverall$meanTempPulse1[2], 
                  ymin = treatmentTempStatsOverall$meanTempPulse1[2] - treatmentTempStatsOverall$sdTempPulse1[2], 
                  ymax = treatmentTempStatsOverall$meanTempPulse1[2] + treatmentTempStatsOverall$sdTempPulse1[2]), 
              fill = plotColors[1], alpha = 0.15) + #Pulse 1 treatment ribbon
  geom_segment(aes(x = tempClean$dateTime[301], xend = tempClean$dateTime[395], 
                   y = treatmentTempStatsOverall$meanTempPulse2[2], yend = treatmentTempStatsOverall$meanTempPulse2[2]), 
               color = plotColors[1], linetype = 3) + #Pulse 2 treatment segment
  geom_ribbon(data = tempClean[301:395], 
              aes(x = dateTime, 
                  y = treatmentTempStatsOverall$meanTempPulse2[2], 
                  ymin = treatmentTempStatsOverall$meanTempPulse2[2] - treatmentTempStatsOverall$sdTempPulse2[2], 
                  ymax = treatmentTempStatsOverall$meanTempPulse2[2] + treatmentTempStatsOverall$sdTempPulse2[2]), 
              fill = plotColors[1], alpha = 0.15) + #Pulse 2 treatment ribbon
  geom_line(aes(x = dateTime, y = controlTemp), color = plotColors[2]) + #Control treatment temperature
  geom_segment(aes(x = tempClean$dateTime[31], xend = tempClean$dateTime[108], 
                   y = treatmentTempStatsOverall$meanTempPulse1[1], yend = treatmentTempStatsOverall$meanTempPulse1[1]), 
               color = plotColors[2], linetype = 3) + #Pulse 1 control segment
  geom_ribbon(data = tempClean[31:108], 
              aes(x = dateTime, 
                  y = treatmentTempStatsOverall$meanTempPulse1[1], 
                  ymin = treatmentTempStatsOverall$meanTempPulse1[1] - treatmentTempStatsOverall$sdTempPulse1[1], 
                  ymax = treatmentTempStatsOverall$meanTempPulse1[1] + treatmentTempStatsOverall$sdTempPulse1[1]), 
              fill = plotColors[2], alpha = 0.15) + #Pulse 1 control ribbon
  geom_segment(aes(x = tempClean$dateTime[301], xend = tempClean$dateTime[395], 
                   y = treatmentTempStatsOverall$meanTempPulse2[1], yend = treatmentTempStatsOverall$meanTempPulse2[1]), 
               color = plotColors[2], linetype = 3) + #Pulse 2 control segment
  geom_ribbon(data = tempClean[301:395], 
              aes(x = dateTime, 
                  y = treatmentTempStatsOverall$meanTempPulse2[1], 
                  ymin = treatmentTempStatsOverall$meanTempPulse2[1] - treatmentTempStatsOverall$sdTempPulse2[1], 
                  ymax = treatmentTempStatsOverall$meanTempPulse2[1] + treatmentTempStatsOverall$sdTempPulse2[1]), 
              fill = plotColors[2], alpha = 0.15) + #Pulse 2 treatment ribbon
  geom_vline(xintercept = as.POSIXct(ymd_hms("2023-07-31 16:00:00")), linetype = 3, color = "black") + #Pre-exposure TTR timepoint
  geom_vline(xintercept = as.POSIXct(ymd_hms("2023-08-01 16:50:00")), linetype = 3, color = "black") + #Pulse 1 TTR timepoint
  geom_vline(xintercept = as.POSIXct(ymd_hms("2023-08-04 16:00:00")), linetype = 3, color = "black") + #Pulse 2 TTR timepoint
  scale_x_datetime(name = "") +
  scale_y_continuous(name = "Temperature (ºC)",
                     limits = c(14.9,33),
                     breaks = c(seq(15,30,5), seq(31,33,1))) +
  theme_classic(base_size = 15)
#Combine data from all dataframes and select columns of interest. Use rowwise operations to calculate average temperature for each treatment at each timepoint. Plot colder temepratures for each timepoint. Add a ribbon with the overall average colder temperature and SD. Add a line for the overall average colder temperature. Repeat with the cold temperature. Modify x-axis label. Modify y-axis.
ggsave("figures/exp-temp.pdf", height = 8.5, width = 11)
```

```{r}
mainPlot <- tempClean[4:395,] %>%
  dplyr::select(dateTime, 
                temp10a, temp10b,
                temp11a, temp11b,
                temp12a, temp12b, 
                temp13a, temp13b) %>%
  rowwise() %>%
  mutate(., controlTemp = mean(c(temp10a, temp10b,
                                 temp12a, temp12b), na.rm = TRUE),
         treatmentTemp = mean(c(temp11a, temp11b,
                                temp13a, temp13b), na.rm = TRUE)) %>%
  ggplot(., aes(x = dateTime, y = treatmentTemp)) +
  geom_line(color = plotColors[1]) + #Average treatment temperature
  geom_segment(aes(x = tempClean$dateTime[31], xend = tempClean$dateTime[108], 
                   y = treatmentTempStatsOverall$meanTempPulse1[2], yend = treatmentTempStatsOverall$meanTempPulse1[2]), 
               color = plotColors[1], linetype = 3) + #Pulse 1 treatment segment
  geom_ribbon(data = tempClean[31:108], 
              aes(x = dateTime, 
                  y = treatmentTempStatsOverall$meanTempPulse1[2], 
                  ymin = treatmentTempStatsOverall$meanTempPulse1[2] - treatmentTempStatsOverall$sdTempPulse1[2], 
                  ymax = treatmentTempStatsOverall$meanTempPulse1[2] + treatmentTempStatsOverall$sdTempPulse1[2]), 
              fill = plotColors[1], alpha = 0.10) + #Pulse 1 treatment ribbon
  geom_segment(aes(x = tempClean$dateTime[301], xend = tempClean$dateTime[395], 
                   y = treatmentTempStatsOverall$meanTempPulse2[2], yend = treatmentTempStatsOverall$meanTempPulse2[2]), 
               color = plotColors[1], linetype = 3) + #Pulse 2 treatment segment
  geom_ribbon(data = tempClean[301:395], 
              aes(x = dateTime, 
                  y = treatmentTempStatsOverall$meanTempPulse2[2], 
                  ymin = treatmentTempStatsOverall$meanTempPulse2[2] - treatmentTempStatsOverall$sdTempPulse2[2], 
                  ymax = treatmentTempStatsOverall$meanTempPulse2[2] + treatmentTempStatsOverall$sdTempPulse2[2]), 
              fill = plotColors[1], alpha = 0.10) + #Pulse 2 treatment ribbon
  geom_line(aes(x = dateTime, y = controlTemp), color = plotColors[2]) + #Control treatment temperature
  geom_segment(aes(x = tempClean$dateTime[31], xend = tempClean$dateTime[108], 
                   y = treatmentTempStatsOverall$meanTempPulse1[1], yend = treatmentTempStatsOverall$meanTempPulse1[1]), 
               color = plotColors[2], linetype = 3) + #Pulse 1 control segment
  geom_ribbon(data = tempClean[31:108], 
              aes(x = dateTime, 
                  y = treatmentTempStatsOverall$meanTempPulse1[1], 
                  ymin = treatmentTempStatsOverall$meanTempPulse1[1] - treatmentTempStatsOverall$sdTempPulse1[1], 
                  ymax = treatmentTempStatsOverall$meanTempPulse1[1] + treatmentTempStatsOverall$sdTempPulse1[1]), 
              fill = plotColors[2], alpha = 0.15) + #Pulse 1 control ribbon
  geom_segment(aes(x = tempClean$dateTime[301], xend = tempClean$dateTime[395], 
                   y = treatmentTempStatsOverall$meanTempPulse2[1], yend = treatmentTempStatsOverall$meanTempPulse2[1]), 
               color = plotColors[2], linetype = 3) + #Pulse 2 control segment
  geom_ribbon(data = tempClean[301:395], 
              aes(x = dateTime, 
                  y = treatmentTempStatsOverall$meanTempPulse2[1], 
                  ymin = treatmentTempStatsOverall$meanTempPulse2[1] - treatmentTempStatsOverall$sdTempPulse2[1], 
                  ymax = treatmentTempStatsOverall$meanTempPulse2[1] + treatmentTempStatsOverall$sdTempPulse2[1]), 
              fill = plotColors[2], alpha = 0.25) + #Pulse 2 control ribbon
  geom_vline(xintercept = as.POSIXct(ymd_hms("2023-07-31 16:00:00")), linetype = 3, color = "black") + #Pre-exposure TTR timepoint
  geom_vline(xintercept = as.POSIXct(ymd_hms("2023-08-01 16:50:00")), linetype = 3, color = "black") + #Pulse 1 TTR timepoint
  geom_vline(xintercept = as.POSIXct(ymd_hms("2023-08-04 16:00:00")), linetype = 3, color = "black") + #Pulse 2 TTR timepoint
  scale_x_datetime(name = "") +
  scale_y_continuous(name = "Temperature (ºC)",
                     limits = c(14.9,33),
                     breaks = c(seq(15,30,5), seq(31,33,1))) +
  ggtitle("A. Overall Experimental Temperature") +
  theme_classic(base_size = 15)
mainPlot
```

```{r}
pulse2Plot <- tempClean[301:394,] %>%
  dplyr::select(dateTime, 
                temp10a, temp10b,
                temp11a, temp11b,
                temp12a, temp12b, 
                temp13a, temp13b) %>%
  rowwise() %>%
  mutate(., tank10avg = mean(c(temp10a, temp10b), na.rm = TRUE),
         tank11avg = mean(c(temp11a, temp11b), na.rm = TRUE),
         tank12avg = mean(c(temp12a, temp12b), na.rm = TRUE),
         tank13avg = mean(c(temp13a, temp13b), na.rm = TRUE)) %>%
  ggplot(., aes(x = dateTime, y = tank10avg)) +
  geom_line(color = plotColors[2]) +
  geom_line(aes(x = dateTime, y = tank11avg), color = plotColors[1]) + 
  geom_line(aes(x = dateTime, y = tank12avg), color = plotColors[2]) +
  geom_line(aes(x = dateTime, y = tank13avg), color = plotColors[1]) + 
  scale_x_datetime(name = "") +
  scale_y_continuous(name = "Temperature (ºC)",
                     limits = c(29,32.5)) +
  ggtitle("B. Temperatures for Second Heat Stress") +
  theme_classic(base_size = 15) + theme(axis.text.x = element_text(angle = 45, vjust = 0.55),
                                        plot.margin = margin(b = 0))
#Average treatment temperature #Take temperature data for the second pulse and average data at each time point for each tank.
pulse2Plot
```

```{r, warning = FALSE}
mainPlot / pulse2Plot +
  plot_layout(heights = c(5, 1)) #Create multipanel plot. Use plot_layout to make the overal experimental temperature plot larger than the pulse 2 plot

ggsave("figures/exp-temp-with-pulse2.pdf", height = 8.5, width = 11)
```






