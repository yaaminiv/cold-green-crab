---
title: "03-TTR-analysis-WA"
author: "Yaamini Venkataraman"
date: '2025-04-01'
output: html_document
---

In this document I'll examine how time-to-right (TTR) varies by temperature and time for WA, ME, and NH crabs. Parasite surveys were also conducted for these crabs.

# Set up R Markdown document

```{bash}
mkdir ../../output/mult-pop-heat
mkdir ../../output/mult-pop-heat/03-TTR-analysis
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../../output/mult-pop-heat/03-TTR-analysis/")) #Set root directory
```

```{r}
getwd()
```

# Install packages

```{r packages, include=FALSE}
#install.packages("tidyverse")
#install.packages("plotrix")
#install.packages("RColorBrewer")
#install.packages("lme4")
#install.packages("emmeans")
#install.packages("ggpubr")
#install.packages("patchwork")
require(tidyverse)
require(plotrix)
require(RColorBrewer)
require(lme4)
require(emmeans)
require(ggpubr)
require(patchwork)
```

```{r}
sessionInfo()
```

# Import data

## WA

```{r}
rawTTRWA <- read.csv("../../../data/mult-pop-heat/WA_HSP_TTR.csv", header = TRUE, na.strings = c("N/A", "NA")) #Import raw data
head(rawTTRWA)
```

```{r}
genotypeWA <- read.csv("../../../data/mult-pop-heat/WA_genotype.csv", header = TRUE) %>%
  dplyr::select(., -c(extraction.date:gel.date, notes)) %>%
  mutate(., presenceC = case_when(genotype == "CC" ~ "Y",
                                  genotype == "CT" ~ "Y",
                                  genotype == "TT" ~ "N")) %>%
  mutate(., presenceT = case_when(genotype == "CC" ~ "N",
                                  genotype == "CT" ~ "Y",
                                  genotype == "TT" ~ "Y")) #Import genotype data. Remove unnecessary columns. Create a crab.ID column to match with other data and ensure it is numeric. Add columns for precense of C and T
head(genotypeWA) #Confirm import
```

## ME

```{r}
rawTTRME <- read.csv("../../../data/mult-pop-heat/ME_HSP_TTR.csv", header = TRUE, na.strings = c("N/A", "NA")) #Import raw data
head(rawTTRME)
```

```{r}
genotypeME <- read.csv("../../../data/mult-pop-heat/ME_genotype.csv", header = TRUE) %>%
  dplyr::select(., -c(extraction.date:gel.date, notes)) %>%
  mutate(., presenceC = case_when(genotype == "CC" ~ "Y",
                                  genotype == "CT" ~ "Y",
                                  genotype == "TT" ~ "N")) %>%
  mutate(., presenceT = case_when(genotype == "CC" ~ "N",
                                  genotype == "CT" ~ "Y",
                                  genotype == "TT" ~ "Y")) #Import genotype data. Remove unnecessary columns. Create a crab.ID column to match with other data and ensure it is numeric. Add columns for precense of C and T
head(genotypeME) #Confirm import
```

```{r}
parasiteME <- read.csv("../../../data/mult-pop-heat/ME_HSP_Para.csv", header = TRUE) %>%
  mutate(., meta_Intensity = Meta/CW) %>%
  mutate(., acanth_Intensity = Acanth/CW) %>%
  dplyr::select(., -c(Species:CW)) #Import parasite data and calculate intensity. Select columns of interest.
head(parasiteME) #Confirm import
```

```{r}
genotypeME$crab.ID %>% unique(.) %>% length(.)
parasiteME$crab.ID %>% unique(.) %>% length(.)
```

```{r}
left_join(genotypeME, parasiteME, by = "crab.ID") %>%
  filter(., is.na(Meta) == TRUE)
```

## NH

```{r}
rawTTRNH <- read.csv("../../../data/mult-pop-heat/NH_HSP_TTR.csv", header = TRUE, na.strings = c("N/A", "NA")) %>%
  dplyr::select(-carapace.length) %>%
  filter(., timepoint == 0) #Import raw data and remove carapace length column. Only use data from the first timepoint.
head(rawTTRNH)
```

```{r}
genotypeNH <- read.csv("../../../data/mult-pop-heat/NH_genotype.csv", header = TRUE) %>%
  dplyr::select(., -c(extraction.date:gel.date, notes)) %>%
  mutate(., presenceC = case_when(genotype == "CC" ~ "Y",
                                  genotype == "CT" ~ "Y",
                                  genotype == "TT" ~ "N")) %>%
  mutate(., presenceT = case_when(genotype == "CC" ~ "N",
                                  genotype == "CT" ~ "Y",
                                  genotype == "TT" ~ "Y")) #Import genotype data. Remove unnecessary columns. Create a crab.ID column to match with other data and ensure it is nuNHric. Add columns for precense of C and T
head(genotypeNH) #Confirm import
```

```{r}
parasiteNH <- read.csv("../../../data/mult-pop-heat/NH_HSP_Para.csv", header = TRUE) %>%
  mutate(., meta_Intensity = Meta/CW) %>%
  mutate(., acanth_Intensity = Acanth/CW) %>%
  dplyr::select(., -c(Species:CW)) #Import parasite data and select columns of interest
head(parasiteNH) #Confirm import
```

```{r}
genotypeNH$crab.ID %>% unique(.) %>% length(.)
parasiteNH$crab.ID %>% unique(.) %>% length(.)
```

```{r}
left_join(genotypeNH, parasiteNH, by = "crab.ID") %>%
  filter(., is.na(Meta) == TRUE)
```

# Format data

```{r}
modTTRWA <- rawTTRWA %>%
  dplyr::select(., -notes) %>%
  mutate(., integument.cont = case_when(integument.color == "BG" ~ 0.5,
                                        integument.color == "G" ~ 1.0,
                                        integument.color == "YG" ~ 1.5,
                                        integument.color == "Y" ~ 2.0,
                                        integument.color == "YO" ~ 2.5,
                                        integument.color == "O" ~ 3,
                                        integument.color == "RO" ~ 3.5,
                                        integument.color == "R" ~ 4)) %>%
  mutate(., trial.1 = na_if(trial.1, 91.00)) %>%
  mutate(., trial.2 = na_if(trial.2, 91.00)) %>%
  mutate(., trial.3 = na_if(trial.3, 91.00)) %>%
  rowwise(.) %>% 
  mutate(., TTRavg = mean(c(trial.1, trial.2, trial.3), na.rm = TRUE)) %>%
  mutate(., TTRSE = std.error(c(trial.1, trial.2, trial.3), na.rm = TRUE)) %>%
  left_join(x = ., y = (genotypeWA %>% dplyr::select(crab.ID, genotype:presenceT)), by = "crab.ID") %>%
  ungroup(.) #Remove sampling ID and notes columns. Use case_when to create a column of continuous integument color metrics. Change all 91 to NA, calculate average and SE using data from the three TTR trials using rowwise operations. Ungroup. Join with genotype data.
head(modTTRWA) #Confirm formatting
```

```{r}
modTTRME <- rawTTRME %>%
  dplyr::select(., -notes) %>%
  mutate(., integument.cont = case_when(integument.color == "BG" ~ 0.5,
                                        integument.color == "G" ~ 1.0,
                                        integument.color == "YG" ~ 1.5,
                                        integument.color == "Y" ~ 2.0,
                                        integument.color == "YO" ~ 2.5,
                                        integument.color == "O" ~ 3,
                                        integument.color == "RO" ~ 3.5,
                                        integument.color == "R" ~ 4)) %>%
  mutate(., trial.1 = na_if(trial.1, 91.00)) %>%
  mutate(., trial.2 = na_if(trial.2, 91.00)) %>%
  mutate(., trial.3 = na_if(trial.3, 91.00)) %>%
  rowwise(.) %>% 
  mutate(., TTRavg = mean(c(trial.1, trial.2, trial.3), na.rm = TRUE)) %>%
  mutate(., TTRSE = std.error(c(trial.1, trial.2, trial.3), na.rm = TRUE)) %>%
  left_join(x = ., y = (genotypeME %>% dplyr::select(crab.ID, genotype:presenceT)), by = "crab.ID") %>%
  left_join(x = ., y = parasiteME, by = "crab.ID") %>%
  ungroup(.) #Remove sampling ID and notes columns. Use case_when to create a column of continuous integument color metrics. Change all 91 to NA, calculate average and SE using data from the three TTR trials using rowwise operations. Ungroup. Join with genotype data.
head(modTTRME) #Confirm formatting
```

```{r}
modTTRNH <- rawTTRNH %>%
  dplyr::select(., -notes) %>%
  mutate(., integument.cont = case_when(integument.color == "BG" ~ 0.5,
                                        integument.color == "G" ~ 1.0,
                                        integument.color == "YG" ~ 1.5,
                                        integument.color == "Y" ~ 2.0,
                                        integument.color == "YO" ~ 2.5,
                                        integument.color == "O" ~ 3,
                                        integument.color == "RO" ~ 3.5,
                                        integument.color == "R" ~ 4)) %>%
  mutate(., trial.1 = na_if(trial.1, 91.00)) %>%
  mutate(., trial.2 = na_if(trial.2, 91.00)) %>%
  mutate(., trial.3 = na_if(trial.3, 91.00)) %>%
  rowwise(.) %>% 
  mutate(., TTRavg = mean(c(trial.1, trial.2, trial.3), na.rm = TRUE)) %>%
  mutate(., TTRSE = std.error(c(trial.1, trial.2, trial.3), na.rm = TRUE)) %>%
  left_join(x = ., y = (genotypeNH %>% dplyr::select(crab.ID, genotype:presenceT)), by = "crab.ID") %>%
  left_join(x = ., y = parasiteNH, by = "crab.ID") %>%
  ungroup(.) #Remove sampling ID and notes columns. Use case_when to create a column of continuous integument color metrics. Change all 91 to NA, calculate average and SE using data from the three TTR trials using rowwise operations. Ungroup. Join with genotype data.
head(modTTRNH) #Confirm formatting
```

# Data exploration

```{bash}
mkdir figures
```

```{r}
plotColors <- c(brewer.pal(9, "Greens")[7],
                brewer.pal(9, "Oranges")[7],
                brewer.pal(9, "Purples")[7]) #Create color scheme
```

## Sex

```{r}
modTTRWA %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = sex)) +
  geom_jitter(alpha = 0.75) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRWA$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-sex-WA.pdf", height = 8.5, width = 11)
```

```{r}
modTTRME %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = sex)) +
  geom_jitter(alpha = 0.75) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRME$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-sex-ME.pdf", height = 8.5, width = 11)
```

```{r}
modTTRNH %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = sex)) +
  geom_jitter(alpha = 0.75) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRNH$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-sex-NH.pdf", height = 8.5, width = 11)
```

## Integument color

```{r}
modTTRWA %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = integument.color)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRWA$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  scale_color_manual(values = c("#66C2A5","#A6D96A","#D9EF8B","#FFFF99","#FDAE61","#F46D43","#D53E4F"),
                     name = "Integument",
                     breaks = c("BG", "G", "YG", "Y", "YO", "O", "RO"),
                     labels = c("BG", "G", "YG", "Y", "YO", "O", "RO")) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-integument-WA.pdf", height = 8.5, width = 11)
```

```{r}
modTTRME %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = integument.color)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRME$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  scale_color_manual(values = c("#66C2A5","#A6D96A","#D9EF8B","#FFFF99","#FDAE61","#F46D43","#D53E4F"),
                     name = "Integument",
                     breaks = c("BG", "G", "YG", "Y", "YO", "O", "RO"),
                     labels = c("BG", "G", "YG", "Y", "YO", "O", "RO")) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-integument-ME.pdf", height = 8.5, width = 11)
```

```{r}
modTTRNH %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = integument.color)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRNH$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  scale_color_manual(values = c("#66C2A5","#A6D96A","#D9EF8B","#FFFF99","#FDAE61","#F46D43","#D53E4F"),
                     name = "Integument",
                     breaks = c("BG", "G", "YG", "Y", "YO", "O", "RO"),
                     labels = c("BG", "G", "YG", "Y", "YO", "O", "RO")) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-integument-NH.pdf", height = 8.5, width = 11)
```

## Missing swimmer

```{r}
modTTRWA %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = as.factor(missing.swimmer))) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRWA$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-missswim-WA.pdf", height = 8.5, width = 11)
```

```{r}
modTTRME %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = as.factor(missing.swimmer))) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRME$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-missswim-ME.pdf", height = 8.5, width = 11)
```

```{r}
modTTRNH %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = as.factor(missing.swimmer))) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRNH$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-missswim-NH.pdf", height = 8.5, width = 11)
```

## Weight

```{r}
modTTRWA %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = weight)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRWA$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-weight-WA.pdf", height = 8.5, width = 11)
```

```{r}
modTTRWA %>%
  filter(timepoint == 0) %>%
  summarize(., weight_mean = mean(weight, na.rm = TRUE),
            weight_sd = sd(weight, na.rm = TRUE)) #Calculate mean ± SD for weight
#Weight = 25.11071 g ± 11.35336 g
```

```{r}
modTTRME %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = weight)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRME$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-weight-ME.pdf", height = 8.5, width = 11)
```

```{r}
modTTRME %>%
  filter(timepoint == 0) %>%
  summarize(., weight_mean = mean(weight, na.rm = TRUE),
            weight_sd = sd(weight, na.rm = TRUE)) #Calculate mean ± SD for weight
#Weight = 28.094 g ± 7.443818 g
```

```{r}
modTTRNH %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = weight)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRNH$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-weight-NH.pdf", height = 8.5, width = 11)
```

```{r}
modTTRNH %>%
  filter(timepoint == 0) %>%
  summarize(., weight_mean = mean(weight, na.rm = TRUE),
            weight_sd = sd(weight, na.rm = TRUE)) #Calculate mean ± SD for weight
#Weight = 73.25467 g ± 21.15626 g
```

## Carapace width

```{r}
modTTRWA %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = carapace.width)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRWA$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-carapaceWidth-WA.pdf", height = 8.5, width = 11)
```

```{r}
modTTRWA %>%
  filter(timepoint == 0) %>%
  summarize(., cw_mean = mean(carapace.width, na.rm = TRUE),
            cw_sd = sd(carapace.width, na.rm = TRUE)) #Calculate mean ± SD for carapace width
#CW = 48.92857 mm ± 5.623552 mm
```

```{r}
modTTRME %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = carapace.width)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRME$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-carapaceWidth-ME.pdf", height = 8.5, width = 11)
```

```{r}
modTTRME %>%
  filter(timepoint == 0) %>%
  summarize(., cw_mean = mean(carapace.width, na.rm = TRUE),
            cw_sd = sd(carapace.width, na.rm = TRUE)) #Calculate mean ± SD for carapace width
#CW = 50.76667 mm ± 4.11627 mm
```

```{r}
modTTRNH %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = carapace.width)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRNH$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-carapaceWidth-NH.pdf", height = 8.5, width = 11)
```

```{r}
modTTRNH %>%
  filter(timepoint == 0) %>%
  summarize(., cw_mean = mean(carapace.width, na.rm = TRUE),
            cw_sd = sd(carapace.width, na.rm = TRUE)) #Calculate mean ± SD for carapace width
#CW = 68.53333 mm ± 7.443757 mm
```

## Parasite

```{r}
modTTRME %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = Meta)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRME$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 95, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-meta-ME.pdf", height = 8.5, width = 11)
```

```{r}
modTTRME %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = meta_Intensity)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRME$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 95, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-meta_Intensity-ME.pdf", height = 8.5, width = 11)
```

```{r}
modTTRME %>%
  filter(., timepoint == 22) %>%
  summarize(., meta_mean = mean(Meta, na.rm = TRUE),
            meta_sd = sd(Meta, na.rm = TRUE),
            meta_Intensity_mean = mean(meta_Intensity, na.rm = TRUE),
            meta_Intensity_sd = sd(meta_Intensity, na.rm = TRUE))

range(modTTRME %>% filter(., timepoint == 22) %>% dplyr::select(Meta))

#Meta: 23.46667 ± 27.01817	
#Meta intensity: 0.4614469 ± 0.5599341
```

```{r}
modTTRNH %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = meta_Intensity)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRNH$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 95, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-meta_Intensity-NH.pdf", height = 8.5, width = 11)
```

```{r}
modTTRNH %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = acanth_Intensity)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRNH$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 95, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-acanth_Intensity-NH.pdf", height = 8.5, width = 11)
```

```{r}
modTTRNH %>%
  summarize(., meta_mean = mean(Meta, na.rm = TRUE),
            meta_sd = sd(Meta, na.rm = TRUE),
            meta_Intensity_mean = mean(meta_Intensity, na.rm = TRUE),
            meta_Intensity_sd = sd(meta_Intensity, na.rm = TRUE))

range(modTTRNH %>% dplyr::select(Meta))

#Meta: 72.13333 ± 149.3107
#Meta intensity: 1.064814 ± 2.197705
#Meta range:  0-471
```

```{r}
modTTRNH %>%
  summarize(., acanth_mean = mean(Acanth, na.rm = TRUE),
            acanth_sd = sd(Acanth, na.rm = TRUE),
            acanth_Intensity_mean = mean(acanth_Intensity, na.rm = TRUE),
            acanth_Intensity_sd = sd(acanth_Intensity, na.rm = TRUE))

range(modTTRNH %>% dplyr::select(Acanth))

#Acanth: 2.866667 ± 5.692936
#Acanth intensity: 0.03836931 ± 0.07250577
#Range: 0-19
```

## Genotype

```{r}
modTTRWA %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = genotype)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRWA$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 95, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-genotype-WA.pdf", height = 8.5, width = 11)
```

```{r}
modTTRWA %>%
  filter(., timepoint == 22) %>%
  filter(., is.na(genotype) == FALSE) %>%
  group_by(., genotype) %>%
  summarize(., count = n()) %>%
  ggplot(mapping = aes(x = "", y = count, fill = genotype)) +
  geom_col(color = "black") +
  coord_polar(theta = "y") +
  scale_fill_manual(name = "Genotype",
                    values = c("grey90", "grey45", "grey0")) +
  theme_void(base_size = 15) #Group data by genotype and summarize. Plot counts as a pie chart.
ggsave("figures/genotype-pie-chart-WA.jpg", height = 8.5, width = 11)
```

```{r}
modTTRME %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = genotype)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRME$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 95, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-genotype-ME.pdf", height = 8.5, width = 11)
```

```{r}
modTTRME %>%
  filter(., timepoint == 22) %>%
  filter(., is.na(genotype) == FALSE) %>%
  group_by(., genotype) %>%
  summarize(., count = n()) %>%
  ggplot(mapping = aes(x = "", y = count, fill = genotype)) +
  geom_col(color = "black") +
  coord_polar(theta = "y") +
  scale_fill_manual(name = "Genotype",
                    values = c("grey90", "grey45", "grey0")) +
  theme_void(base_size = 15) #Group data by genotype and summarize. Plot counts as a pie chart.
ggsave("figures/genotype-pie-chart-ME.jpg", height = 8.5, width = 11)
```

```{r}
modTTRNH %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = genotype)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRNH$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 95, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-genotype-NH.pdf", height = 8.5, width = 11)
```

```{r}
modTTRNH %>%
  filter(., timepoint == 22) %>%
  filter(., is.na(genotype) == FALSE) %>%
  group_by(., genotype) %>%
  summarize(., count = n()) %>%
  ggplot(mapping = aes(x = "", y = count, fill = genotype)) +
  geom_col(color = "black") +
  coord_polar(theta = "y") +
  scale_fill_manual(name = "Genotype",
                    values = c("grey90", "grey45", "grey0")) +
  theme_void(base_size = 15) #Group data by genotype and summarize. Plot counts as a pie chart.
ggsave("figures/genotype-pie-chart-NH.jpg", height = 8.5, width = 11)
```

### Hardy-Weinberg equilibrium

Since I have the genotype data, I want to see if my population is in Hardy-Weinbergy equilibrium. I used [this calculator](https://www.cog-genomics.org/software/stats) to obtain p-values.

```{r}
genSummarizedWA <- modTTRWA %>%
  filter(., timepoint == 22) %>%
  group_by(., genotype) %>%
  summarize(., count = n())
genSummarizedWA
```

WA population p-value: 0.083319498041584

```{r}
genSummarizedME <- modTTRME %>%
  filter(., timepoint == 22) %>%
  group_by(., genotype) %>%
  summarize(., count = n())
genSummarizedME
```

Full population p-value: 0.55112220438981

```{r}
genSummarizedNH <- modTTRNH %>%
  filter(., timepoint == 22) %>%
  group_by(., genotype) %>%
  summarize(., count = n())
genSummarizedNH
```

Full population p-value: 1

All three populations used in this experiment are in Hardy-Weinberg equilibrium. 

# Assess differences in TTR based on time and genotype

I will use a linear mixed effects model with individual as a random effect to analyze the data, following [this tutorial](https://jontalle.web.engr.illinois.edu/MISC/lme4/bw_LME_tutorial.pdf).

## WA

```{r}
hist(modTTRWA$TTRavg)
hist(x = log(modTTRWA$TTRavg)) #Log transformation helps normalize data
```

### Assess importance of demographic variables

The first thing I am going to do is create a mdoel with just the demographic variables. I will assess if any of them significantly influence TTR, then include those factors only in my null model to understand the impact of timepoint on TTR.

```{r}
TTRmodelWADV <- lmer(log(TTRavg) ~ as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                       (1|crab.ID), 
                     data = modTTRWA, REML = FALSE) #Run model with sex, integument color, carapace width, weight, and missing swimmer information as fixed effects, and individual as a random effect. Change the likelihood estimator (REML = FALSE) to compare models with LRT later.
```

```{r}
TTRnullSexWA <- lmer(log(TTRavg) ~ integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                       (1|crab.ID), 
                     data = modTTRWA, REML = FALSE) #Run model without variable of interest to identify significance
anova(TTRnullSexWA, TTRmodelWADV)
```

```{r}
TTRnullIntegumentWA <- lmer(log(TTRavg) ~ as.factor(sex) + carapace.width + weight + as.factor(missing.swimmer) + 
                              (1|crab.ID), 
                            data = modTTRWA, REML = FALSE) #Run model without variable of interest to identify significance
anova(TTRnullIntegumentWA, TTRmodelWADV) #Integument color is not significant
```

```{r}
TTRnullCWWA <- lmer(log(TTRavg) ~ as.factor(sex) + integument.cont + weight + as.factor(missing.swimmer) + 
                      (1|crab.ID), 
                    data = modTTRWA, REML = FALSE) #Run model without variable of interest to identify significance
anova(TTRnullCWWA, TTRmodelWADV) #CW is not significant
```

```{r}
TTRnullWeightWA <- lmer(log(TTRavg) ~ as.factor(sex) + integument.cont + carapace.width + as.factor(missing.swimmer) + 
                          (1|crab.ID), 
                        data = modTTRWA, REML = FALSE) #Run model without variable of interest to identify significance
anova(TTRnullWeightWA, TTRmodelWADV) #Weight is not significant
```

```{r}
TTRnullSwimmerWA <- lmer(log(TTRavg) ~ as.factor(sex) + integument.cont + carapace.width + weight +
                           (1|crab.ID), 
                         data = modTTRWA, REML = FALSE) #Run model without variable of interest to identify significance
anova(TTRnullSwimmerWA, TTRmodelWADV) #Missing swimmer is not significant
```

Even without correcting for multiple comparisons, none of the demographic variables are significant! I will not include them in my model to undersatnd the importance of timepoint.

### Assess importance of timepoint

Timepoint is ~22 hours of heat exposure.

```{r}
TTRnullTimepointWA <- lmer(log(TTRavg) ~ (1|crab.ID), data = modTTRWA, REML = FALSE) #Run null model without timepoint
TTRmodelTimepointWA <- lmer(log(TTRavg) ~ as.factor(timepoint) + (1|crab.ID), data = modTTRWA, REML = FALSE) #Run model with timepoint
anova(TTRnullTimepointWA, TTRmodelTimepointWA) #Timepoint is a significant predictor
```

```{r}
TTRmodelWA_timepoint <- emmeans(TTRmodelTimepointWA, pairwise~timepoint, adjust = "tukey") #Pairwise tukey test for timepoint
TTRmodelWA_timepoint$contrasts #t = -5.033, p <.0001 
```

### Assess importance of genotype

```{r}
TTRfullGenotypeWA <- lmer(log(TTRavg) ~ as.factor(timepoint) + 
                            as.factor(genotype) + 
                            (1|crab.ID), 
                          data = modTTRWA, REML = FALSE) #Run model with genotype to identify significance of predictor
anova(TTRmodelTimepointWA, TTRfullGenotypeWA) #No significant impact of genotype
```

```{r}
TTRpresenceCWA <- lmer(log(TTRavg) ~ as.factor(timepoint) + 
                         as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                         as.factor(presenceC) + 
                         (1|crab.ID), 
                       data = modTTRWA, REML = FALSE) #Run model with presenceC to identify significance of predictor
anova(TTRmodelTimepointWA, TTRpresenceCWA) #No significant impact of C allele
```

```{r}
TTRpresenceTWA <- lmer(log(TTRavg) ~ as.factor(timepoint) + 
                         as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                         as.factor(presenceT) + 
                         (1|crab.ID), 
                       data = modTTRWA, REML = FALSE) #Run model with presenceT to identify significance of predictor
anova(TTRmodelTimepointWA, TTRpresenceTWA) #No significant impact of T allele
```

### Final model

```{r}
summary(TTRmodelTimepointWA) #The final model has timepoint but not genotype
```

```{r}
var.lmerWA <- c(0.01051, 0.24498) #Save variances of random effects as a new vector (crab ID, residuals)
percentvar.lmerWA <- (100*var.lmerWA)/sum(var.lmerWA) #Calculate percent variances
percentvar.lmerWA[1] #Crab ID accounts for 4.113664% of variance
```

### Save model output

```{r}
TTRModelComparisonsWA <- rbind(broom::tidy(anova(TTRnullSexWA, TTRmodelWADV)),
                               broom::tidy(anova(TTRnullIntegumentWA, TTRmodelWADV)),
                               broom::tidy(anova(TTRnullCWWA, TTRmodelWADV)),
                               broom::tidy(anova(TTRnullWeightWA, TTRmodelWADV)),
                               broom::tidy(anova(TTRnullSwimmerWA, TTRmodelWADV)),
                               broom::tidy(anova(TTRnullTimepointWA, TTRmodelTimepointWA)),
                               broom::tidy(anova(TTRmodelTimepointWA, TTRfullGenotypeWA)),
                               broom::tidy(anova(TTRmodelTimepointWA, TTRpresenceCWA)),
                               broom::tidy(anova(TTRmodelTimepointWA, TTRpresenceTWA))) %>%
  mutate(., p.adj = p.adjust(p.value, method = "bonferroni")) #Create table for model comparison output. Adjust for multiple comparisons.
TTRModelComparisonsWA #Confirm modifications
```

```{r}
write.csv(TTRModelComparisonsWA, "ttr-model-comparison-stat-output-WA.csv", quote = FALSE, row.names = FALSE) #Save statistical output
```

## ME

```{r}
hist(modTTRME$TTRavg)
hist(x = log(modTTRME$TTRavg)) #Log transformation helps normalize data
```

### Assess importance of demographic variables

The first thing I am going to do is create a mdoel with just the demographic variables. I will assess if any of them significantly influence TTR, then include those factors only in my null model to understand the impact of timepoint on TTR.

```{r}
TTRmodelMEDV <- lmer(log(TTRavg) ~ as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) +
                       meta_Intensity +
                       (1|crab.ID), 
                     data = modTTRME, REML = FALSE) #Run model with sex, integument color, carapace width, weight, and missing swimmer information as fixed effects, and individual as a random effect. Also investigate the influence of parasite intensity on TTR. Change the likelihood estimator (REML = FALSE) to compare models with LRT later.
```

```{r}
TTRnullSexME <- lmer(log(TTRavg) ~ integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                       meta_Intensity +
                       (1|crab.ID), 
                     data = modTTRME, REML = FALSE) #Run model without variable of interest to identify significance
anova(TTRnullSexME, TTRmodelMEDV)
```

```{r}
TTRnullIntegumentME <- lmer(log(TTRavg) ~ as.factor(sex) + carapace.width + weight + as.factor(missing.swimmer) + 
                              meta_Intensity +
                              (1|crab.ID), 
                            data = modTTRME, REML = FALSE) #Run model without variable of interest to identify significance
anova(TTRnullIntegumentME, TTRmodelMEDV) #Integument color is not significant
```

```{r}
TTRnullCWME <- lmer(log(TTRavg) ~ as.factor(sex) + integument.cont + weight + as.factor(missing.swimmer) + 
                      meta_Intensity +
                      (1|crab.ID), 
                    data = modTTRME, REML = FALSE) #Run model without variable of interest to identify significance
anova(TTRnullCWME, TTRmodelMEDV) #CW is not significant
```

```{r}
TTRnullWeightME <- lmer(log(TTRavg) ~ as.factor(sex) + integument.cont + carapace.width + as.factor(missing.swimmer) + 
                          meta_Intensity +
                          (1|crab.ID), 
                        data = modTTRME, REML = FALSE) #Run model without variable of interest to identify significance
anova(TTRnullWeightME, TTRmodelMEDV) #Weight is not significant
```

```{r}
TTRnullSwimmerME <- lmer(log(TTRavg) ~ as.factor(sex) + integument.cont + carapace.width + weight +
                           meta_Intensity +
                           (1|crab.ID), 
                         data = modTTRME, REML = FALSE) #Run model without variable of interest to identify significance
anova(TTRnullSwimmerME, TTRmodelMEDV) #Missing swimmer is not significant
```

```{r}
TTRnullMetaME <- lmer(log(TTRavg) ~ as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) +
                           (1|crab.ID), 
                         data = modTTRME, REML = FALSE) #Run model without variable of interest to identify significance
anova(TTRnullMetaME, TTRmodelMEDV) #Meta intensity is not significant
```

No demographic variables are significant.

### Assess importance of timepoint

```{r}
TTRnullTimepointME <- lmer(log(TTRavg) ~ (1|crab.ID), data = modTTRME, REML = FALSE) #Run null model without timepoint
TTRmodelTimepointME <- lmer(log(TTRavg) ~ as.factor(timepoint) + (1|crab.ID), data = modTTRME, REML = FALSE) #Run model with timepoint
anova(TTRnullTimepointME, TTRmodelTimepointME) #Timepoint is a significant predictor
```

```{r}
TTRmodelME_timepoint <- emmeans(TTRmodelTimepointME, pairwise~timepoint, adjust = "tukey") #Pairwise tukey test for timepoint
TTRmodelME_timepoint$contrasts #t = -5.093, p <.0001 
```

### Assess importance of genotype

I'll look at full genotype only. Since there were no TT crabs tested, C is present in every crab, so I can't test the significance of the presence of the C allele! Testing for the presence of the T allele will just duplicate the full genotype contrast.


```{r}
TTRfullGenotypeME <- lmer(log(TTRavg) ~ as.factor(timepoint) + 
                            as.factor(genotype) + 
                            (1|crab.ID), 
                          data = modTTRME, REML = FALSE) #Run model with genotype to identify significance of predictor
anova(TTRmodelTimepointME, TTRfullGenotypeME) #Significant impact of genotype
```

```{r}
TTRmodelME_genotype <- emmeans(TTRfullGenotypeME, pairwise~as.factor(genotype), adjust = "tukey") #Pairwise tukey test for genotype
TTRmodelME_genotype$contrasts #t = 2.408, p = 0.0219
```

### Final model

```{r}
summary(TTRmodelTimepointME) #The final model has timepoint but not genotype
```

```{r}
var.lmerME <- c(0.07166, 0.16365) #Save variances of random effects as a new vector (crab ID, residuals)
percentvar.lmerME <- (100*var.lmerME)/sum(var.lmerME) #Calculate percent variances
percentvar.lmerME[1] #Crab ID accounts for 0.16365% of variance
```

### Save model output

```{r}
TTRModelComparisonsME <- rbind(broom::tidy(anova(TTRnullSexME, TTRmodelMEDV)),
                               broom::tidy(anova(TTRnullIntegumentME, TTRmodelMEDV)),
                               broom::tidy(anova(TTRnullCWME, TTRmodelMEDV)),
                               broom::tidy(anova(TTRnullWeightME, TTRmodelMEDV)),
                               broom::tidy(anova(TTRnullSwimmerME, TTRmodelMEDV)),
                               broom::tidy(anova(TTRnullTimepointME, TTRmodelTimepointME)),
                               broom::tidy(anova(TTRmodelTimepointME, TTRfullGenotypeME))) %>%
  mutate(., p.adj = p.adjust(p.value, method = "bonferroni")) #Create table for model comparison output. Adjust for multiple comparisons.
TTRModelComparisonsME #Confirm modifications
```

```{r}
write.csv(TTRModelComparisonsME, "ttr-model-comparison-stat-output-ME.csv", quote = FALSE, row.names = FALSE) #Save statistical output
```

## Save Tukey Test output

```{r}
rbind(broom::tidy(TTRmodelWA_timepoint$contrasts) %>%
        mutate(., population = "WA"),
      broom::tidy(TTRmodelME_timepoint$contrasts) %>%
        mutate(., population = "ME"),
      broom::tidy(TTRmodelME_genotype$contrasts) %>%
        mutate(., population = "ME")) %>%
  write.csv(., "tukey-test-output.csv", quote = FALSE, row.names = FALSE)
```

## Calculate average values

```{r}
rbind(modTTRWA %>%
        group_by(., timepoint) %>%
        summarize(., mean = mean(TTRavg, na.rm = TRUE), sd = sd(TTRavg, na.rm = TRUE)) %>%
        mutate(., population = "WA"),
      modTTRME %>%
        group_by(., timepoint) %>%
        summarize(., mean = mean(TTRavg, na.rm = TRUE), sd = sd(TTRavg, na.rm = TRUE)) %>%
        mutate(., population = "ME")) %>%
  write.csv("average-TTR-calculations.csv", quote = FALSE, row.names = FALSE) #Calculate mean and SD for TTR at each time point for populations. Save as a csv
```

```{r}
rbind(modTTRWA %>%
        group_by(., timepoint, genotype) %>%
        summarize(., mean = mean(TTRavg, na.rm = TRUE), sd = sd(TTRavg, na.rm = TRUE)) %>%
        mutate(., population = "WA"),
      modTTRME %>%
        group_by(., timepoint, genotype) %>%
        summarize(., mean = mean(TTRavg, na.rm = TRUE), sd = sd(TTRavg, na.rm = TRUE)) %>%
        mutate(., population = "ME")) %>%
  write.csv("average-TTR-calculations-genotype.csv", quote = FALSE, row.names = FALSE) #Calculate mean and SD for TTR at each time point and by genotype for populations. Save as a csv
```

# NH

I only have one timepoint for the NH experiment (no 22 hour heat stress), so I didn't include NH in the time analysis above. I will examine genotype's impact on TTR in these crabs using a GLM (no repeated measurements).

First, I will see if parasite terms need to be included in the model.

```{r}
TTRparasiteNH <- glm(log(TTRavg) ~ as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                       meta_Intensity + acanth_Intensity, 
                     data = modTTRNH) #Run model with parasite intensity information
summary(TTRparasiteNH) #Parasite intensity is not significant
```


```{r}
TTRfullGenotypeNH <- glm(log(TTRavg) ~ as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                           as.factor(genotype), 
                         data = modTTRNH) #Run model with genotype to identify significance of predictor
summary(TTRfullGenotypeNH) #Significant impact of genotype. t = 3.536, p = 0.00767
```

```{r}
TTRmodelNH_genotype <- emmeans(TTRfullGenotypeNH, pairwise~as.factor(genotype), adjust = "tukey") #Pairwise tukey test for genotype
TTRmodelNH_genotype$contrasts #t = -3.536, p = 0.0077
```

## Save model output

```{r}
TTRModelComparisons <- rbind(broom::tidy(anova(TTRnullTimepointWA, TTRmodelWA)),
                             broom::tidy(anova(TTRmodelWA, TTRfullGenotypeWA)),
                             broom::tidy(anova(TTRmodelWA, TTRpresenceCWA)),
                             broom::tidy(anova(TTRmodelWA, TTRpresenceTWA)),
                             broom::tidy(anova(TTRnullTimepointME, TTRmodelME)),
                             broom::tidy(anova(TTRnullIntensityME, TTRmodelME)), 
                             broom::tidy(anova(TTRmodelMERevised, TTRfullGenotypeME))) %>%
  mutate(., p.adj = p.adjust(p.value, method = "bonferroni")) #Create table for model comparison output. Adjust for multiple comparisons.
TTRModelComparisons #Confirm modifications
```

There is no significant impact of genotype on average TTR in WA, but there is a significant impact of genotype in ME and NH populations!

```{r}
write.csv(TTRModelComparisons, "ttr-model-comparison-stat-output.csv", quote = FALSE, row.names = FALSE) #Save statistical output
```

## Calculate average values



```{r}
modTTRNH %>%
  group_by(., genotype) %>%
  summarize(., mean = mean(TTRavg, na.rm = TRUE), sd = sd(TTRavg, na.rm = TRUE)) #NH averages by genotype irrespective of timepoint (timepoint was not significant).
```

# Plots

## Average TTR plot by population

```{r}
rbind(modTTRWA %>%
        mutate(., population = "WA",
               Meta = 0,
               Acanth = 0,
               meta_Intensity = "NA",
               acanth_Intensity = "NA"), 
      modTTRME %>%
        mutate(., population = "ME")) %>%
  dplyr::select(., c(timepoint, TTRavg, population)) %>%
  filter(., is.na(TTRavg) == FALSE) %>%
  distinct(.) %>%
  ggplot(mapping = aes(x = as.character(timepoint), y = TTRavg, color = population, shape = population)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(position = position_dodge(width = 0.75)) +
  facet_wrap(~population, scale = "free_y") +
  scale_y_continuous(name = "Average Time-to-Right (s)") +
  scale_x_discrete(name = "Exposure Time (Hours)",
                   labels = c(0, 22)) +
  scale_color_manual(values = c(plotColors[1], plotColors[3]),
                     guide = "none") +
  scale_shape_manual(values = c(15, 19),
                     guide = "none") +
  theme_classic(base_size = 15) + theme(strip.background = element_rect(color = "white")) #Plot average TTR for each crab in a boxplot. Do not show outliers with the OG boxplot, but add them in with geom_jitter. Assign colors and shapes to each treatment. Increase base font size.
#ggsave("figures/time-to-right-avg-boxplot.pdf", height = 8.5, width = 11)
```

## Genotype effect plots

```{r}
rbind(modTTRWA %>%
        mutate(., population = "WA",
               Meta = 0,
               Acanth = 0,
               meta_Intensity = "NA",
               acanth_Intensity = "NA"), 
      modTTRME %>%
        mutate(., population = "ME")) %>%
  dplyr::select(., c(timepoint, TTRavg, presenceT, population)) %>%
  mutate(., presenceTpop = case_when(presenceT == "Y" & population == "ME" ~ "Y_ME",
                                     presenceT == "N" & population == "ME" ~ "N_ME",
                                     presenceT == "Y" & population == "WA" ~ "Y_WA",
                                     presenceT == "N" & population == "WA" ~ "N_WA")) %>%
  filter(., is.na(TTRavg) == FALSE) %>%
  distinct(.) %>%
  ggplot(mapping = aes(x = as.character(timepoint), y = TTRavg, color = presenceTpop, shape = presenceTpop, fill = presenceTpop)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.5) + 
  geom_jitter(position = position_dodge(width = 0.75)) +
  scale_y_continuous(name = "Average Time-to-Right (s)") +
  scale_x_discrete(name = "Exposure Time (Hours)",
                   labels = c(0, 22)) +
  scale_color_manual(values = c(plotColors[1], plotColors[3],
                                plotColors[1], plotColors[3]),
                     labels = c("ME, CC",
                                "WA, CC",
                                "ME, CT",
                                "WA, CT or TT"),
                     name = "Population & Genotype") +
  scale_shape_manual(values = c(15, 19,
                                15, 19),
                     labels = c("ME, CC",
                                "WA, CC",
                                "ME, CT",
                                "WA, CT or TT"),
                     name = "Population & Genotype") +
  scale_fill_manual(values = c("NA", "NA",
                               plotColors[1], plotColors[3]),
                    labels = c("ME, CC",
                               "WA, CC",
                               "ME, CT",
                               "WA, CT or TT"),
                    name = "Population & Genotype") +
  theme_classic(base_size = 15) + theme(strip.background = element_rect(color = "white"),
                                        strip.text.y = element_blank()) #Plot average TTR for each crab in a boxplot. Do not show outliers with the OG boxplot, but add them in with geom_jitter. Assign colors and shapes to each treatment. Increase base font size.
ggsave("../../output/mult-pop-heat/03-TTR-analysis/figures/time-to-right-by-genotype.pdf", height = 8.5, width = 11)
```

## Multipanel plot

This multipanel plot will include the temperature conditions, TTR by population, and TTR by population and genotype.

### Create individual plots

```{r}
attach("../01-temp-conditions/01-temp-conditions-mult-pop-heat.RData")
tempCleanME <- tempCleanME
tempCleanWA <- tempCleanWA
detach("file:../01-temp-conditions/01-temp-conditions-mult-pop-heat.RData")
```

```{r}
plotWA <- tempCleanWA[1:93,] %>%
  dplyr::select(dateTime,
                temp1a, temp1b,
                temp2a, temp2b) %>%
  rowwise() %>%
  mutate(., avgTemp = mean(c(temp1a, temp1b,
                             temp2a, temp2b), na.rm = TRUE)) %>%
  ggplot(., aes(x = dateTime, y = avgTemp)) +
  geom_line(color = plotColors[3]) +
  scale_x_datetime(name = "") +
  scale_y_continuous(name = "Temperature (ºC)") +
  ggtitle("A. WA Temperature") +
  theme_classic(base_size = 15)

plotWA
```

```{r}
plotME <- tempCleanME[-c(1:174),] %>%
  dplyr::select(dateTime,
                temp1a, temp1b,
                temp2a, temp2b) %>%
  rowwise() %>%
  mutate(., avgTemp = mean(c(temp1a, temp1b,
                             temp2a, temp2b), na.rm = TRUE)) %>%
  ggplot(., aes(x = dateTime, y = avgTemp)) +
  geom_line(color = plotColors[1]) +
  scale_x_datetime(name = "") +
  scale_y_continuous(name = "") +
  ggtitle("B. ME Temperature") +
  theme_classic(base_size = 15)

plotME
```

```{r}
mainPlot.stat.test <- rbind(broom::tidy(TTRmodelWA_timepoint$contrasts) %>%
                              mutate(., population = "WA"),
                            broom::tidy(TTRmodelME_timepoint$contrasts) %>%
                              mutate(., population = "ME")) %>%
  mutate(., group1 = "0",
         group2 = "22") %>%
  mutate(., y = "TTRavg") %>%
  mutate(., population = as.factor(population)) %>%
  mutate(., p.sig = "****") %>%
  dplyr::select(., population, y, term, group1, group2, statistic, p.value, p.sig) #Create a new dataframe with stats for the main plot
mainPlot.stat.test #Confirm changes
```

```{r}
mainPlot <- rbind(modTTRWA %>%
                    mutate(., population = "WA",
                           Meta = 0,
                           Acanth = 0,
                           meta_Intensity = "NA",
                           acanth_Intensity = "NA"), 
                  modTTRME %>%
                    mutate(., population = "ME")) %>%
  dplyr::select(., c(timepoint, TTRavg, population)) %>%
  filter(., is.na(TTRavg) == FALSE) %>%
  distinct(.) %>%
  ggplot(mapping = aes(x = as.character(timepoint), y = TTRavg, color = population, shape = population)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(position = position_dodge(width = 0.75)) +
  facet_wrap(~population) +
  stat_pvalue_manual(mainPlot.stat.test, label = "p.sig", tip.length = 0, y.position = 20) +
  scale_y_continuous(name = "Average Time-to-Right (s)") +
  scale_x_discrete(name = "Exposure Time (Hours)",
                   labels = c(0, 22)) +
  scale_color_manual(values = c(plotColors[1], plotColors[3]),
                     guide = "none") +
  scale_shape_manual(values = c(15, 19),
                     guide = "none") +
  ggtitle("C. Righting Response by Population") +
  ggpubr::stat_compare_means(label = "p.signif", method = "t.test") +
  theme_classic(base_size = 15) + theme(strip.background = element_rect(color = "white")) #Plot average TTR for each crab in a boxplot. Do not show outliers with the OG boxplot, but add them in with geom_jitter. Assign colors and shapes to each treatment. Increase base font size.
mainPlot
```

```{r}
broom::tidy(TTRmodelME_genotype$contrasts)
```

```{r}
genotypePlot <- rbind(modTTRWA %>%
                        mutate(., population = "WA",
                               Meta = 0,
                               Acanth = 0,
                               meta_Intensity = "NA",
                               acanth_Intensity = "NA"), 
                      modTTRME %>%
                        mutate(., population = "ME")) %>%
  dplyr::select(., c(timepoint, TTRavg, presenceT, population)) %>%
  mutate(., presenceTpop = case_when(presenceT == "Y" & population == "ME" ~ "1_Y_ME",
                                     presenceT == "N" & population == "ME" ~ "2_N_ME",
                                     presenceT == "Y" & population == "WA" ~ "3_Y_WA",
                                     presenceT == "N" & population == "WA" ~ "4_N_WA")) %>%
  filter(., is.na(TTRavg) == FALSE) %>%
  distinct(.) %>%
  ggplot(mapping = aes(x = as.character(timepoint), y = TTRavg, color = presenceTpop, shape = presenceTpop, fill = presenceTpop)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.5) + 
  geom_jitter(position = position_dodge(width = 0.75)) +
  geom_segment(aes(x = 1.7, xend = 1.9, 
                   y = 15, yend = 15),
               color = "black", linewidth = 0.2) + #Add significance bar
  annotate("text", x = 1.8, y = 15.2, label = "***") + #Add significance asterisks
  scale_y_continuous(name = "") +
  scale_x_discrete(name = "Exposure Time (Hours)",
                   labels = c(0, 22)) +
  scale_color_manual(values = c(plotColors[1], plotColors[1],
                                plotColors[3], plotColors[3]),
                     labels = c("ME, CT",
                                "ME, CC",
                                "WA, CT or TT",
                                "WA, CC"),
                     name = "") +
  scale_shape_manual(values = c(15, 15,
                                19, 19),
                     labels = c("ME, CT",
                                "ME, CC",
                                "WA, CT or TT",
                                "WA, CC"),
                     name = "") +
  scale_fill_manual(values = c(plotColors[1], "NA",
                               plotColors[3], "NA"),
                    labels = c("ME, CT",
                               "ME, CC",
                               "WA, CT or TT",
                               "WA, CC"),
                    name = "") +
  ggtitle("D. Righting Response by Genotype") +
  theme_classic(base_size = 15) + theme(strip.background = element_rect(color = "white"),
                                        strip.text.y = element_blank(),
                                        legend.position = c(0.2, 0.9)) #Plot average TTR for each crab in a boxplot. Do not show outliers with the OG boxplot, but add them in with geom_jitter. Assign colors and shapes to each treatment. Move legend to the inside of the plot. Increase base font size.
genotypePlot
```
### Combine plots

```{r}
plotWA  + plotME + mainPlot + genotypePlot +
  plot_layout(heights = c(1, 3))
ggsave("figures/time-to-right-multipanel.pdf", height = 8.5, width = 11)
```

## Supplementary NH plot

```{r}
modTTRNH %>%
  mutate(., population = "NH") %>%
  dplyr::select(., c(timepoint, TTRavg, genotype, population)) %>%
  filter(., is.na(TTRavg) == FALSE) %>%
  distinct(.) %>%
  ggplot(mapping = aes(x = as.character(genotype), y = TTRavg, shape = genotype)) +
  geom_boxplot(outlier.shape = NA, color = plotColors[2]) + 
  geom_jitter(position = position_dodge(width = 0.75), color = plotColors[2]) +
  # facet_wrap(~genotype) +
  scale_y_continuous(name = "Average Time-to-Right (s)") +
  scale_x_discrete(name = "") +
  scale_shape_manual(name = "Genotype",
                     values = c(15, 19)) +
  theme_classic(base_size = 15) + theme(strip.background = element_rect(color = "white"),
                                        strip.text.y = element_blank(),
                                        axis.text.x = element_blank(),
                                        axis.ticks.x = element_blank()) #Plot average TTR for each crab in a boxplot. Do not show outliers with the OG boxplot, but add them in with geom_jitter. Assign colors and shapes to each treatment. Increase base font size.
ggsave("figures/time-to-right-genotype-NH.pdf", height = 8.5, width = 11)
```

# Population comparison

## Format data

```{r}
modTTRCombined <- rbind(modTTRWA %>%
                          mutate(., population = "WA",
                                 Meta = 0,
                                 Acanth = 0,
                                 meta_Intensity = "NA",
                                 acanth_Intensity = "NA"), 
                        modTTRME %>%
                          mutate(., population = "ME")) %>%
  dplyr::select(., timepoint, crab.ID, 
                TTRavg, 
                population, 
                sex, integument.cont, carapace.width, weight, missing.swimmer, 
                Meta, Acanth, meta_Intensity, acanth_Intensity,
                genotype, presenceC, presenceT) #Rbind data from both populations, and select columns of interest to use in the model
head(modTTRCombined) #Confirm import
```

## Run model

```{r}
TTRCombinedNull <- lmer(log(TTRavg) ~ timepoint + 
                          as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                          (1|crab.ID), 
                        data = modTTRCombined, REML = FALSE) #Null model without population
summary(TTRCombinedNull) #Crab ID doesn't explain any variation!
```

```{r}
var.lmerCombined <- c(0.04355, 0.20392) #Save variances of random effects as a new vector (crab ID, residuals)
percentvar.lmerCombined <- (100*var.lmerCombined)/sum(var.lmerCombined) #Calculate percent variances
percentvar.lmerCombined[1] #Crab ID accounts for 17.59809% of variance
```

```{r}
TTRPopulation <- lmer(log(TTRavg) ~ timepoint + 
                        as.factor(population) +
                        as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                        (1|crab.ID), 
                      data = modTTRCombined, REML = FALSE) #Model with population
anova(TTRCombinedNull, TTRPopulation) #Population is a marginally significant factor. Chisq = 3.5767, p = 0.0586
```

Population has a marginal impact on average TTR.
