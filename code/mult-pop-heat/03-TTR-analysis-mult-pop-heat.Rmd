---
title: "03-TTR-analysis-WA"
author: "Yaamini Venkataraman"
date: '2025-04-01'
output: html_document
---

In this document I'll examine how time-to-right (TTR) varies by temperature and time for WA, ME, and NH crabs. Parasite surveys were also conducted for these crabs.

# Set up R Markdown document

```{bash}
mkdir ../../output/mult-pop-heat
mkdir ../../output/mult-pop-heat/03-TTR-analysis
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../../output/mult-pop-heat/03-TTR-analysis/")) #Set root directory
```

```{r}
getwd()
```

# Install packages

```{r packages, include=FALSE}
#install.packages("tidyverse")
#install.packages("plotrix")
#install.packages("RColorBrewer")
#install.packages("lme4")
#install.packages("ggpubr")
#install.packages("patchwork")
require(tidyverse)
require(plotrix)
require(RColorBrewer)
require(lme4)
require(ggpubr)
require(patchwork)
```

```{r}
sessionInfo()
```

# Import data

## WA

```{r}
rawTTRWA <- read.csv("../../../data/mult-pop-heat/WA_HSP_TTR.csv", header = TRUE, na.strings = c("N/A", "NA")) #Import raw data
head(rawTTRWA)
```

```{r}
genotypeWA <- read.csv("../../../data/mult-pop-heat/WA_genotype.csv", header = TRUE) %>%
  dplyr::select(., -c(extraction.date:gel.date, notes)) %>%
  mutate(., presenceC = case_when(genotype == "CC" ~ "Y",
                                  genotype == "CT" ~ "Y",
                                  genotype == "TT" ~ "N")) %>%
  mutate(., presenceT = case_when(genotype == "CC" ~ "N",
                                  genotype == "CT" ~ "Y",
                                  genotype == "TT" ~ "Y")) #Import genotype data. Remove unnecessary columns. Create a crab.ID column to match with other data and ensure it is numeric. Add columns for precense of C and T
head(genotypeWA) #Confirm import
```

## ME

```{r}
rawTTRME <- read.csv("../../../data/mult-pop-heat/ME_HSP_TTR.csv", header = TRUE, na.strings = c("N/A", "NA")) #Import raw data
head(rawTTRME)
```

```{r}
genotypeME <- read.csv("../../../data/mult-pop-heat/ME_genotype.csv", header = TRUE) %>%
  dplyr::select(., -c(extraction.date:gel.date, notes)) %>%
  mutate(., presenceC = case_when(genotype == "CC" ~ "Y",
                                  genotype == "CT" ~ "Y",
                                  genotype == "TT" ~ "N")) %>%
  mutate(., presenceT = case_when(genotype == "CC" ~ "N",
                                  genotype == "CT" ~ "Y",
                                  genotype == "TT" ~ "Y")) #Import genotype data. Remove unnecessary columns. Create a crab.ID column to match with other data and ensure it is numeric. Add columns for precense of C and T
head(genotypeME) #Confirm import
```

```{r}
parasiteME <- read.csv("../../../data/mult-pop-heat/ME_HSP_Para.csv", header = TRUE) %>%
  mutate(., meta_Intensity = Meta/CW) %>%
  mutate(., acanth_Intensity = Acanth/CW) %>%
  dplyr::select(., -c(Species:CW)) #Import parasite data and calculate intensity. Select columns of interest.
head(parasiteME) #Confirm import
```

```{r}
genotypeME$crab.ID %>% unique(.) %>% length(.)
parasiteME$crab.ID %>% unique(.) %>% length(.)
```

```{r}
left_join(genotypeME, parasiteME, by = "crab.ID") %>%
  filter(., is.na(Meta) == TRUE)
```

## NH

```{r}
rawTTRNH <- read.csv("../../../data/mult-pop-heat/NH_HSP_TTR.csv", header = TRUE, na.strings = c("N/A", "NA")) %>%
  dplyr::select(-carapace.length) %>%
  filter(., timepoint == 0) #Import raw data and remove carapace length column. Only use data from the first timepoint.
head(rawTTRNH)
```

```{r}
genotypeNH <- read.csv("../../../data/mult-pop-heat/NH_genotype.csv", header = TRUE) %>%
  dplyr::select(., -c(extraction.date:gel.date, notes)) %>%
  mutate(., presenceC = case_when(genotype == "CC" ~ "Y",
                                  genotype == "CT" ~ "Y",
                                  genotype == "TT" ~ "N")) %>%
  mutate(., presenceT = case_when(genotype == "CC" ~ "N",
                                  genotype == "CT" ~ "Y",
                                  genotype == "TT" ~ "Y")) #Import genotype data. Remove unnecessary columns. Create a crab.ID column to match with other data and ensure it is nuNHric. Add columns for precense of C and T
head(genotypeNH) #Confirm import
```

```{r}
parasiteNH <- read.csv("../../../data/mult-pop-heat/NH_HSP_Para.csv", header = TRUE) %>%
  mutate(., meta_Intensity = Meta/CW) %>%
  mutate(., acanth_Intensity = Acanth/CW) %>%
  dplyr::select(., -c(Species:CW)) #Import parasite data and select columns of interest
head(parasiteNH) #Confirm import
```

```{r}
genotypeNH$crab.ID %>% unique(.) %>% length(.)
parasiteNH$crab.ID %>% unique(.) %>% length(.)
```

```{r}
left_join(genotypeNH, parasiteNH, by = "crab.ID") %>%
  filter(., is.na(Meta) == TRUE)
```

# Format data

```{r}
modTTRWA <- rawTTRWA %>%
  dplyr::select(., -notes) %>%
  mutate(., integument.cont = case_when(integument.color == "BG" ~ 0.5,
                                        integument.color == "G" ~ 1.0,
                                        integument.color == "YG" ~ 1.5,
                                        integument.color == "Y" ~ 2.0,
                                        integument.color == "YO" ~ 2.5,
                                        integument.color == "O" ~ 3,
                                        integument.color == "RO" ~ 3.5,
                                        integument.color == "R" ~ 4)) %>%
  mutate(., trial.1 = na_if(trial.1, 91.00)) %>%
  mutate(., trial.2 = na_if(trial.2, 91.00)) %>%
  mutate(., trial.3 = na_if(trial.3, 91.00)) %>%
  rowwise(.) %>% 
  mutate(., TTRavg = mean(c(trial.1, trial.2, trial.3), na.rm = TRUE)) %>%
  mutate(., TTRSE = std.error(c(trial.1, trial.2, trial.3), na.rm = TRUE)) %>%
  left_join(x = ., y = (genotypeWA %>% dplyr::select(crab.ID, genotype:presenceT)), by = "crab.ID") %>%
  ungroup(.) #Remove sampling ID and notes columns. Use case_when to create a column of continuous integument color metrics. Change all 91 to NA, calculate average and SE using data from the three TTR trials using rowwise operations. Ungroup. Join with genotype data.
head(modTTRWA) #Confirm formatting
```

```{r}
modTTRME <- rawTTRME %>%
  dplyr::select(., -notes) %>%
  mutate(., integument.cont = case_when(integument.color == "BG" ~ 0.5,
                                        integument.color == "G" ~ 1.0,
                                        integument.color == "YG" ~ 1.5,
                                        integument.color == "Y" ~ 2.0,
                                        integument.color == "YO" ~ 2.5,
                                        integument.color == "O" ~ 3,
                                        integument.color == "RO" ~ 3.5,
                                        integument.color == "R" ~ 4)) %>%
  mutate(., trial.1 = na_if(trial.1, 91.00)) %>%
  mutate(., trial.2 = na_if(trial.2, 91.00)) %>%
  mutate(., trial.3 = na_if(trial.3, 91.00)) %>%
  rowwise(.) %>% 
  mutate(., TTRavg = mean(c(trial.1, trial.2, trial.3), na.rm = TRUE)) %>%
  mutate(., TTRSE = std.error(c(trial.1, trial.2, trial.3), na.rm = TRUE)) %>%
  left_join(x = ., y = (genotypeME %>% dplyr::select(crab.ID, genotype:presenceT)), by = "crab.ID") %>%
  left_join(x = ., y = parasiteME, by = "crab.ID") %>%
  ungroup(.) #Remove sampling ID and notes columns. Use case_when to create a column of continuous integument color metrics. Change all 91 to NA, calculate average and SE using data from the three TTR trials using rowwise operations. Ungroup. Join with genotype data.
head(modTTRME) #Confirm formatting
```

```{r}
modTTRNH <- rawTTRNH %>%
  dplyr::select(., -notes) %>%
  mutate(., integument.cont = case_when(integument.color == "BG" ~ 0.5,
                                        integument.color == "G" ~ 1.0,
                                        integument.color == "YG" ~ 1.5,
                                        integument.color == "Y" ~ 2.0,
                                        integument.color == "YO" ~ 2.5,
                                        integument.color == "O" ~ 3,
                                        integument.color == "RO" ~ 3.5,
                                        integument.color == "R" ~ 4)) %>%
  mutate(., trial.1 = na_if(trial.1, 91.00)) %>%
  mutate(., trial.2 = na_if(trial.2, 91.00)) %>%
  mutate(., trial.3 = na_if(trial.3, 91.00)) %>%
  rowwise(.) %>% 
  mutate(., TTRavg = mean(c(trial.1, trial.2, trial.3), na.rm = TRUE)) %>%
  mutate(., TTRSE = std.error(c(trial.1, trial.2, trial.3), na.rm = TRUE)) %>%
  left_join(x = ., y = (genotypeNH %>% dplyr::select(crab.ID, genotype:presenceT)), by = "crab.ID") %>%
  left_join(x = ., y = parasiteNH, by = "crab.ID") %>%
  ungroup(.) #Remove sampling ID and notes columns. Use case_when to create a column of continuous integument color metrics. Change all 91 to NA, calculate average and SE using data from the three TTR trials using rowwise operations. Ungroup. Join with genotype data.
head(modTTRNH) #Confirm formatting
```

# Data exploration

```{bash}
mkdir figures
```

```{r}
plotColors <- c(brewer.pal(9, "Greens")[7],
                brewer.pal(9, "Oranges")[7],
                brewer.pal(9, "Purples")[7]) #Create color scheme
```

## Sex

```{r}
modTTRWA %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = sex)) +
  geom_jitter(alpha = 0.75) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRWA$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-sex-WA.pdf", height = 8.5, width = 11)
```

```{r}
modTTRME %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = sex)) +
  geom_jitter(alpha = 0.75) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRME$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-sex-ME.pdf", height = 8.5, width = 11)
```

```{r}
modTTRNH %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = sex)) +
  geom_jitter(alpha = 0.75) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRNH$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-sex-NH.pdf", height = 8.5, width = 11)
```

## Integument color

```{r}
modTTRWA %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = integument.color)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRWA$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  scale_color_manual(values = c("#66C2A5","#A6D96A","#D9EF8B","#FFFF99","#FDAE61","#F46D43","#D53E4F"),
                     name = "Integument",
                     breaks = c("BG", "G", "YG", "Y", "YO", "O", "RO"),
                     labels = c("BG", "G", "YG", "Y", "YO", "O", "RO")) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-integument-WA.pdf", height = 8.5, width = 11)
```

```{r}
modTTRME %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = integument.color)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRME$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  scale_color_manual(values = c("#66C2A5","#A6D96A","#D9EF8B","#FFFF99","#FDAE61","#F46D43","#D53E4F"),
                     name = "Integument",
                     breaks = c("BG", "G", "YG", "Y", "YO", "O", "RO"),
                     labels = c("BG", "G", "YG", "Y", "YO", "O", "RO")) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-integument-ME.pdf", height = 8.5, width = 11)
```

```{r}
modTTRNH %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = integument.color)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRNH$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  scale_color_manual(values = c("#66C2A5","#A6D96A","#D9EF8B","#FFFF99","#FDAE61","#F46D43","#D53E4F"),
                     name = "Integument",
                     breaks = c("BG", "G", "YG", "Y", "YO", "O", "RO"),
                     labels = c("BG", "G", "YG", "Y", "YO", "O", "RO")) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-integument-NH.pdf", height = 8.5, width = 11)
```

## Missing swimmer

```{r}
modTTRWA %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = as.factor(missing.swimmer))) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRWA$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-missswim-WA.pdf", height = 8.5, width = 11)
```

```{r}
modTTRME %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = as.factor(missing.swimmer))) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRME$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-missswim-ME.pdf", height = 8.5, width = 11)
```

```{r}
modTTRNH %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = as.factor(missing.swimmer))) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRNH$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-missswim-NH.pdf", height = 8.5, width = 11)
```

## Weight

```{r}
modTTRWA %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = weight)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRWA$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-weight-WA.pdf", height = 8.5, width = 11)
```

```{r}
modTTRWA %>%
  filter(timepoint == 0) %>%
  summarize(., weight_mean = mean(weight, na.rm = TRUE),
            weight_sd = sd(weight, na.rm = TRUE)) #Calculate mean ± SD for weight
#Weight = 25.11071 g ± 11.35336 g
```

```{r}
modTTRME %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = weight)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRME$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-weight-ME.pdf", height = 8.5, width = 11)
```

```{r}
modTTRME %>%
  filter(timepoint == 0) %>%
  summarize(., weight_mean = mean(weight, na.rm = TRUE),
            weight_sd = sd(weight, na.rm = TRUE)) #Calculate mean ± SD for weight
#Weight = 28.094 g ± 7.443818 g
```

```{r}
modTTRNH %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = weight)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRNH$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-weight-NH.pdf", height = 8.5, width = 11)
```

```{r}
modTTRNH %>%
  filter(timepoint == 0) %>%
  summarize(., weight_mean = mean(weight, na.rm = TRUE),
            weight_sd = sd(weight, na.rm = TRUE)) #Calculate mean ± SD for weight
#Weight = 73.25467 g ± 21.15626 g
```

## Carapace width

```{r}
modTTRWA %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = carapace.width)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRWA$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-carapaceWidth-WA.pdf", height = 8.5, width = 11)
```

```{r}
modTTRWA %>%
  filter(timepoint == 0) %>%
  summarize(., cw_mean = mean(carapace.width, na.rm = TRUE),
            cw_sd = sd(carapace.width, na.rm = TRUE)) #Calculate mean ± SD for carapace width
#CW = 48.92857 mm ± 5.623552 mm
```

```{r}
modTTRME %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = carapace.width)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRME$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-carapaceWidth-ME.pdf", height = 8.5, width = 11)
```

```{r}
modTTRME %>%
  filter(timepoint == 0) %>%
  summarize(., cw_mean = mean(carapace.width, na.rm = TRUE),
            cw_sd = sd(carapace.width, na.rm = TRUE)) #Calculate mean ± SD for carapace width
#CW = 50.76667 mm ± 4.11627 mm
```

```{r}
modTTRNH %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = carapace.width)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRNH$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 100, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-carapaceWidth-NH.pdf", height = 8.5, width = 11)
```

```{r}
modTTRNH %>%
  filter(timepoint == 0) %>%
  summarize(., cw_mean = mean(carapace.width, na.rm = TRUE),
            cw_sd = sd(carapace.width, na.rm = TRUE)) #Calculate mean ± SD for carapace width
#CW = 68.53333 mm ± 7.443757 mm
```

## Parasite

```{r}
modTTRME %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = Meta)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRME$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 95, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-meta-ME.pdf", height = 8.5, width = 11)
```

```{r}
modTTRME %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = meta_Intensity)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRME$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 95, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-meta_Intensity-ME.pdf", height = 8.5, width = 11)
```

```{r}
modTTRME %>%
  filter(., timepoint == 22) %>%
  summarize(., meta_mean = mean(Meta, na.rm = TRUE),
            meta_sd = sd(Meta, na.rm = TRUE),
            meta_Intensity_mean = mean(meta_Intensity, na.rm = TRUE),
            meta_Intensity_sd = sd(meta_Intensity, na.rm = TRUE))

range(modTTRME %>% filter(., timepoint == 22) %>% dplyr::select(Meta))

#Meta: 23.46667 ± 27.01817	
#Meta intensity: 0.4614469 ± 0.5599341
```

```{r}
modTTRNH %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = meta_Intensity)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRNH$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 95, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-meta_Intensity-NH.pdf", height = 8.5, width = 11)
```

```{r}
modTTRNH %>%
  filter(., timepoint == 22) %>%
  summarize(., meta_mean = mean(Meta, na.rm = TRUE),
            meta_sd = sd(Meta, na.rm = TRUE),
            meta_Intensity_mean = mean(meta_Intensity, na.rm = TRUE),
            meta_Intensity_sd = sd(meta_Intensity, na.rm = TRUE))

#Meta:
#Meta intensity:
```

```{r}
modTTRNH %>%
  filter(., timepoint == 22) %>%
  summarize(., acanth_mean = mean(Acanth, na.rm = TRUE),
            acanth_sd = sd(Acanth, na.rm = TRUE),
            acanth_Intensity_mean = mean(acanth_Intensity, na.rm = TRUE),
            acanth_Intensity_sd = sd(acanth_Intensity, na.rm = TRUE))

#Acanth: 	
#Acanth intensity: 
```

## Genotype

```{r}
modTTRWA %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = genotype)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRWA$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 95, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-genotype-WA.pdf", height = 8.5, width = 11)
```

```{r}
modTTRWA %>%
  filter(., timepoint == 22) %>%
  filter(., is.na(genotype) == FALSE) %>%
  group_by(., genotype) %>%
  summarize(., count = n()) %>%
  ggplot(mapping = aes(x = "", y = count, fill = genotype)) +
  geom_col(color = "black") +
  coord_polar(theta = "y") +
  scale_fill_manual(name = "Genotype",
                    values = c("grey90", "grey45", "grey0")) +
  theme_void(base_size = 15) #Group data by genotype and summarize. Plot counts as a pie chart.
ggsave("figures/genotype-pie-chart-WA.jpg", height = 8.5, width = 11)
```

```{r}
modTTRME %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = genotype)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRME$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 95, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-genotype-ME.pdf", height = 8.5, width = 11)
```

```{r}
modTTRME %>%
  filter(., timepoint == 22) %>%
  filter(., is.na(genotype) == FALSE) %>%
  group_by(., genotype) %>%
  summarize(., count = n()) %>%
  ggplot(mapping = aes(x = "", y = count, fill = genotype)) +
  geom_col(color = "black") +
  coord_polar(theta = "y") +
  scale_fill_manual(name = "Genotype",
                    values = c("grey90", "grey45", "grey0")) +
  theme_void(base_size = 15) #Group data by genotype and summarize. Plot counts as a pie chart.
ggsave("figures/genotype-pie-chart-ME.jpg", height = 8.5, width = 11)
```

```{r}
modTTRNH %>%
  ggplot(., mapping = aes(x = timepoint, y = TTRavg, color = genotype)) +
  geom_jitter(alpha = 0.8) +
  scale_x_continuous(name = "timepoint",
                     breaks = unique(modTTRNH$timepoint)) +
  scale_y_continuous(name = "Average Time-to-Right (s)",
                     breaks = seq(0, 95, 10)) +
  theme_classic(base_size = 15)
ggsave("figures/time-to-right-genotype-NH.pdf", height = 8.5, width = 11)
```

```{r}
modTTRNH %>%
  filter(., timepoint == 22) %>%
  filter(., is.na(genotype) == FALSE) %>%
  group_by(., genotype) %>%
  summarize(., count = n()) %>%
  ggplot(mapping = aes(x = "", y = count, fill = genotype)) +
  geom_col(color = "black") +
  coord_polar(theta = "y") +
  scale_fill_manual(name = "Genotype",
                    values = c("grey90", "grey45", "grey0")) +
  theme_void(base_size = 15) #Group data by genotype and summarize. Plot counts as a pie chart.
ggsave("figures/genotype-pie-chart-NH.jpg", height = 8.5, width = 11)
```

### Hardy-Weinberg equilibrium

Since I have the genotype data, I want to see if my population is in Hardy-Weinbergy equilibrium. I used [this calculator](https://www.cog-genomics.org/software/stats) to obtain p-values.

```{r}
genSummarizedWA <- modTTRWA %>%
  filter(., timepoint == 22) %>%
  group_by(., genotype) %>%
  summarize(., count = n())
genSummarizedWA
```

WA population p-value: 0.083319498041584

```{r}
genSummarizedME <- modTTRME %>%
  filter(., timepoint == 22) %>%
  group_by(., genotype) %>%
  summarize(., count = n())
genSummarizedME
```

Full population p-value: 0.55112220438981

```{r}
genSummarizedNH <- modTTRNH %>%
  filter(., timepoint == 22) %>%
  group_by(., genotype) %>%
  summarize(., count = n())
genSummarizedNH
```

Full population p-value: 1

All three populations used in this experiment are in Hardy-Weinberg equilibrium. 

# Assess differences in TTR based on time

I will use a linear mixed effects model with individual as a random effect to analyze the data, following [this tutorial](https://jontalle.web.engr.illinois.edu/MISC/lme4/bw_LME_tutorial.pdf).

## WA

```{r}
hist(modTTRWA$TTRavg)
hist(x = log(modTTRWA$TTRavg)) #Log transformation helps normalize data
```

```{r}
TTRmodelWA <- lmer(log(TTRavg) ~ timepoint + 
                     as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                     (1|crab.ID), 
                   data = modTTRWA, REML = FALSE) #Run model with timepoint, integument color, carapace width, weight, and missing swimmer information as fixed effects, and individual as a random effect. Change the likelihood estimator (REML = FALSE) to compare models with LRT later.
summary(TTRmodelWA) #Look at model output.
#Residuals explain more random effect variation than crab ID, crab ID explains very little variation
```

```{r}
var.lmerWA <- c(0.001317, 0.240556) #Save variances of random effects as a new vector (crab ID, residuals)
percentvar.lmerWA <- (100*var.lmerWA)/sum(var.lmerWA) #Calculate percent variances
percentvar.lmerWA[1] #Crab ID accounts for 0.5445006% of variance
```

Now I want to test the importance of timepoint. Timepoint is ~22 hours of heat exposure. I'll include all other factors in the null model to account for any variation they may contribute.

```{r}
TTRnullTimepointWA <- lmer(log(TTRavg) ~ as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + (1|crab.ID), data = modTTRWA, REML = FALSE) #Run null model without timepoint to identify significance of predictor
anova(TTRnullTimepointWA, TTRmodelWA) #Timepoint is a significant predictor
```

## ME

```{r}
hist(modTTRME$TTRavg)
hist(x = log(modTTRME$TTRavg)) #Log transformation helps normalize data
```

```{r}
TTRmodelME <- lmer(log(TTRavg) ~ timepoint + 
                     as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                     meta_Intensity +
                     (1|crab.ID), 
                   data = modTTRME, REML = FALSE) #Run model with timepoint, integument color, carapace width, weight, and missing swimmer information as fixed effects, and individual as a random effect. Also include parasite intensity. Change the likelihood estimator (REML = FALSE) to compare models with LRT later.
summary(TTRmodelME) #Look at model output.
#Residuals explain more random effect variation than crab ID, crab ID explains very little variation
```

```{r}
var.lmerME <- c(0.06281, 0.16365) #Save variances of random effects as a new vector (crab ID, residuals)
percentvar.lmerME <- (100*var.lmerME)/sum(var.lmerME) #Calculate percent variances
percentvar.lmerME[1] #Crab ID accounts for 27.73558% of variance
```

```{r}
TTRnullTimepointME <- lmer(log(TTRavg) ~ as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + meta_Intensity + (1|crab.ID), data = modTTRME, REML = FALSE) #Run null model without timepoint to identify significance of predictor
anova(TTRnullTimepointME, TTRmodelME) #Timepoint is a significant predictor
```

```{r}
TTRnullIntensityME <- lmer(log(TTRavg) ~ timepoint + as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + (1|crab.ID), data = modTTRME, REML = FALSE) #Run null model without timepoint to identify significance of predictor
anova(TTRnullIntensityME, TTRmodelME) #Parasite intensity is not a significant predictor
```

## Save model output

```{r}
TTRModelComparisons <- rbind(broom::tidy(anova(TTRnullTimepointWA, TTRmodelWA)),
                             broom::tidy(anova(TTRnullTimepointME, TTRmodelME)),
                             broom::tidy(anova(TTRnullIntensityME, TTRmodelME))) %>%
  mutate(., p.adj = p.adjust(p.value, method = "bonferroni")) #Create table for model comparison output. Adjust for multiple comparisons.
TTRModelComparisons #Confirm modifications
```

```{r}
write.csv(TTRModelComparisons, "ttr-model-comparison-stat-output.csv", quote = FALSE, row.names = FALSE) #Save statistical output
```

## Calculate average values

```{r}
rbind(modTTRWA %>%
        group_by(., timepoint) %>%
        summarize(., mean = mean(TTRavg, na.rm = TRUE), sd = sd(TTRavg, na.rm = TRUE)) %>%
        mutate(., population = "WA"),
      modTTRME %>%
        group_by(., timepoint) %>%
        summarize(., mean = mean(TTRavg, na.rm = TRUE), sd = sd(TTRavg, na.rm = TRUE)) %>%
        mutate(., population = "ME")) %>%
  write.csv("average-TTR-calculations.csv", quote = FALSE, row.names = FALSE) #Calculate mean and SD for TTR at each time point for populations. Save as a csv
```

# Effect of genotype

Now that I understand the factors that impact TTR in each population, I can determine if genotype also impacts TTR.

## WA

There was a significant impact of time on average TTR in WA.

```{r}
TTRfullGenotypeWA <- lmer(log(TTRavg) ~ timepoint + 
                            as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                            as.factor(genotype) + 
                            (1|crab.ID), 
                          data = modTTRWA, REML = FALSE) #Run model with genotype to identify significance of predictor
anova(TTRmodelWA, TTRfullGenotypeWA) #No significant impact of genotype
```

```{r}
TTRpresenceCWA <- lmer(log(TTRavg) ~ timepoint + 
                         as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                         as.factor(presenceC) + 
                         (1|crab.ID), 
                       data = modTTRWA, REML = FALSE) #Run model with presenceC to identify significance of predictor
anova(TTRmodelWA, TTRpresenceCWA) #No significant impact of C allele
```

```{r}
TTRpresenceTWA <- lmer(log(TTRavg) ~ timepoint + 
                         as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                         as.factor(presenceT) + 
                         (1|crab.ID), 
                       data = modTTRWA, REML = FALSE) #Run model with presenceT to identify significance of predictor
anova(TTRmodelWA, TTRpresenceTWA) #No significant impact of T allele
```

## ME

There was a significant impact of time, but not parasite intensity, on average TTR in ME.

```{r}
TTRmodelMERevised <- lmer(log(TTRavg) ~ timepoint + 
                            as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                            (1|crab.ID), 
                          data = modTTRME, REML = FALSE) #Run model with timepoint, integument color, carapace width, weight, and missing swimmer information as fixed effects, and individual as a random effect. Also include parasite intensity. Change the likelihood estimator (REML = FALSE) to compare models with LRT later.
summary(TTRmodelMERevised) #Look at model output.
#Residuals explain more random effect variation than crab ID, crab ID explains very little variation
```

I'll look at full genotype only. Since there were no TT crabs tested, C is present in every crab, so I can't test the significance of the presence of the C allele! Testing for the presence of the T allele will just duplicate the full genotype contrast.

```{r}
TTRfullGenotypeME <- lmer(log(TTRavg) ~ timepoint + 
                            as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                            as.factor(genotype) + 
                            (1|crab.ID), 
                          data = modTTRME, REML = FALSE) #Run model with genotype to identify significance of predictor
anova(TTRmodelMERevised, TTRfullGenotypeME) #Significant impact of genotype
```

```{r}
summary(TTRfullGenotypeME)
```

```{r}
var.lmerMERevised <- c(0.02651, 0.16365) #Save variances of random effects as a new vector (crab ID, residuals)
percentvar.lmerMERevised <- (100*var.lmerMERevised)/sum(var.lmerMERevised) #Calculate percent variances
percentvar.lmerMERevised[1] #Crab ID accounts for 13.94089% of variance
```

## NH

I only have one timepoint for the NH experiment (no 22 hour heat stress), so I didn't include NH in the time analysis above. I will examine genotype's impact on TTR in these crabs using a GLM (no repeated measurements).

```{r}
TTRfullGenotypeNH <- glm(log(TTRavg) ~ as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                            as.factor(genotype), 
                          data = modTTRNH) #Run model with genotype to identify significance of predictor
summary(TTRfullGenotypeNH) #Significant impact of genotype. t = 3.536, p = 0.00767
```

## Save model output

```{r}
TTRModelComparisons <- rbind(broom::tidy(anova(TTRnullTimepointWA, TTRmodelWA)),
                             broom::tidy(anova(TTRmodelWA, TTRfullGenotypeWA)),
                             broom::tidy(anova(TTRmodelWA, TTRpresenceCWA)),
                             broom::tidy(anova(TTRmodelWA, TTRpresenceTWA)),
                             broom::tidy(anova(TTRnullTimepointME, TTRmodelME)),
                             broom::tidy(anova(TTRnullIntensityME, TTRmodelME)), 
                             broom::tidy(anova(TTRmodelMERevised, TTRfullGenotypeME))) %>%
  mutate(., p.adj = p.adjust(p.value, method = "bonferroni")) #Create table for model comparison output. Adjust for multiple comparisons.
TTRModelComparisons #Confirm modifications
```

There is no significant impact of genotype on average TTR in WA, but there is a significant impact of genotype in ME and NH populations!

```{r}
write.csv(TTRModelComparisons, "ttr-model-comparison-stat-output.csv", quote = FALSE, row.names = FALSE) #Save statistical output
```

## Calculate average values

```{r}
rbind(modTTRWA %>%
        group_by(., timepoint, genotype) %>%
        summarize(., mean = mean(TTRavg, na.rm = TRUE), sd = sd(TTRavg, na.rm = TRUE)) %>%
        mutate(., population = "WA"),
      modTTRME %>%
        group_by(., timepoint, genotype) %>%
        summarize(., mean = mean(TTRavg, na.rm = TRUE), sd = sd(TTRavg, na.rm = TRUE)) %>%
        mutate(., population = "ME")) %>%
  write.csv("average-TTR-calculations-genotype.csv", quote = FALSE, row.names = FALSE) #Calculate mean and SD for TTR at each time point and by genotype for populations. Save as a csv
```

```{r}
modTTRNH %>%
  group_by(., genotype) %>%
  summarize(., mean = mean(TTRavg, na.rm = TRUE), sd = sd(TTRavg, na.rm = TRUE)) #NH averages by genotype irrespective of timepoint (timepoint was not significant).
```

# Plots

## Average TTR plot by population

```{r}
rbind(modTTRWA %>%
        mutate(., population = "WA",
               Meta = 0,
               Acanth = 0,
               meta_Intensity = "NA",
               acanth_Intensity = "NA"), 
      modTTRME %>%
        mutate(., population = "ME")) %>%
  dplyr::select(., c(timepoint, TTRavg, population)) %>%
  filter(., is.na(TTRavg) == FALSE) %>%
  distinct(.) %>%
  ggplot(mapping = aes(x = as.character(timepoint), y = TTRavg, color = population, shape = population)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(position = position_dodge(width = 0.75)) +
  facet_wrap(~population, scale = "free_y") +
  scale_y_continuous(name = "Average Time-to-Right (s)") +
  scale_x_discrete(name = "Exposure Time (Hours)",
                   labels = c(0, 22)) +
  scale_color_manual(values = c(plotColors[1], plotColors[3]),
                     guide = "none") +
  scale_shape_manual(values = c(15, 19),
                     guide = "none") +
  theme_classic(base_size = 15) + theme(strip.background = element_rect(color = "white")) #Plot average TTR for each crab in a boxplot. Do not show outliers with the OG boxplot, but add them in with geom_jitter. Assign colors and shapes to each treatment. Increase base font size.
ggsave("figures/time-to-right-avg-boxplot.pdf", height = 8.5, width = 11)
```

## Genotype effect plots

```{r}
modTTRME %>%
  mutate(., population = "ME") %>%
  dplyr::select(., c(timepoint, TTRavg, genotype, population)) %>%
  filter(., is.na(TTRavg) == FALSE) %>%
  distinct(.) %>%
  ggplot(mapping = aes(x = as.character(timepoint), y = TTRavg, color = population, shape = population)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(position = position_dodge(width = 0.75)) +
  facet_wrap(~genotype, scale = "free_y") +
  scale_y_continuous(name = "Average Time-to-Right (s)") +
  scale_x_discrete(name = "Exposure Time (Hours)",
                   labels = c(0, 22)) +
  scale_color_manual(values = plotColors[1],
                     guide = "none") +
  scale_shape_manual(values = 15,
                     guide = "none") +
  theme_classic(base_size = 15) + theme(strip.background = element_rect(color = "white"),
                                        strip.text.y = element_blank()) #Plot average TTR for each crab in a boxplot. Do not show outliers with the OG boxplot, but add them in with geom_jitter. Assign colors and shapes to each treatment. Increase base font size.
ggsave("figures/time-to-right-by-genotype.pdf", height = 8.5, width = 11)
```

## Multipanel plot

```{r}
mainPlot <- rbind(modTTRWA %>%
                    mutate(., population = "WA",
                           Meta = 0,
                           Acanth = 0,
                           meta_Intensity = "NA",
                           acanth_Intensity = "NA"), 
                  modTTRME %>%
                    mutate(., population = "ME")) %>%
  dplyr::select(., c(timepoint, TTRavg, population)) %>%
  filter(., is.na(TTRavg) == FALSE) %>%
  distinct(.) %>%
  ggplot(mapping = aes(x = as.character(timepoint), y = TTRavg, color = population, shape = population)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(position = position_dodge(width = 0.75)) +
  facet_wrap(~population, scale = "free_y") +
  scale_y_continuous(name = "Average Time-to-Right (s)") +
  scale_x_discrete(name = "Exposure Time (Hours)",
                   labels = c(0, 22)) +
  scale_color_manual(values = c(plotColors[1], plotColors[3]),
                     guide = "none") +
  scale_shape_manual(values = c(15, 19),
                     guide = "none") +
  ggtitle("A. Righting Response by Population") +
  theme_classic(base_size = 15) + theme(strip.background = element_rect(color = "white")) #Plot average TTR for each crab in a boxplot. Do not show outliers with the OG boxplot, but add them in with geom_jitter. Assign colors and shapes to each treatment. Increase base font size.
mainPlot
```

```{r}
genotypePlot <- modTTRME %>%
  mutate(., population = "ME") %>%
  dplyr::select(., c(timepoint, TTRavg, genotype, population)) %>%
  filter(., is.na(TTRavg) == FALSE) %>%
  distinct(.) %>%
  ggplot(mapping = aes(x = as.character(timepoint), y = TTRavg, color = population, shape = population)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(position = position_dodge(width = 0.75)) +
  facet_wrap(~genotype, scale = "free_y") +
  scale_y_continuous(name = "Average Time-to-Right (s)") +
  scale_x_discrete(name = "Exposure Time (Hours)",
                   labels = c(0, 22)) +
  scale_color_manual(values = plotColors[1],
                     guide = "none") +
  scale_shape_manual(values = 15,
                     guide = "none") +
  ggtitle("B. ME Righting Response by Genotype") +
  theme_classic(base_size = 15) + theme(strip.background = element_rect(color = "white"),
                                        strip.text.y = element_blank()) #Plot average TTR for each crab in a boxplot. Do not show outliers with the OG boxplot, but add them in with geom_jitter. Assign colors and shapes to each treatment. Increase base font size.
genotypePlot
```

```{r}
mainPlot / genotypePlot
ggsave("figures/time-to-right-multipanel.pdf", height = 8.5, width = 11)
```

## Supplementary NH plot

```{r}
modTTRNH %>%
  mutate(., population = "NH") %>%
  dplyr::select(., c(timepoint, TTRavg, genotype, population)) %>%
  filter(., is.na(TTRavg) == FALSE) %>%
  distinct(.) %>%
  ggplot(mapping = aes(x = as.character(timepoint), y = TTRavg, color = population, shape = population)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(position = position_dodge(width = 0.75)) +
  facet_wrap(~genotype, scale = "free_y") +
  scale_y_continuous(name = "Average Time-to-Right (s)") +
  scale_x_discrete(name = "Exposure Time (Hours)") +
  scale_color_manual(values = plotColors[2],
                     guide = "none") +
  scale_shape_manual(values = 15,
                     guide = "none") +
  theme_classic(base_size = 15) + theme(strip.background = element_rect(color = "white"),
                                        strip.text.y = element_blank(),
                                        axis.text.x = element_blank(),
                                        axis.ticks.x = element_blank()) #Plot average TTR for each crab in a boxplot. Do not show outliers with the OG boxplot, but add them in with geom_jitter. Assign colors and shapes to each treatment. Increase base font size.
ggsave("figures/time-to-right-genotype-NH.pdf", height = 8.5, width = 11)
```

# Population comparison

## Format data

RE-EVALUATE PARASITE ADDITION BASED ON PARASITE INFORMATION FROM NH

```{r}
modTTRCombined <- rbind(modTTRWA %>%
                          mutate(., population = "WA",
                                 Meta = 0,
                                 Acanth = 0,
                                 meta_Intensity = "NA",
                                 acanth_Intensity = "NA"), 
                        modTTRME %>%
                          mutate(., population = "ME"),
                        modTTRNH %>%
                          mutate(., population = "NH")) %>%
  dplyr::select(., timepoint, crab.ID, 
                TTRavg, 
                population, 
                sex, integument.cont, carapace.width, weight, missing.swimmer, 
                Meta, Acanth, meta_Intensity, acanth_Intensity,
                genotype, presenceC, presenceT) #Rbind data from both populations, and select columns of interest to use in the model
head(modTTRCombined) #Confirm import
```

## Run model

```{r}
TTRCombinedNull <- lmer(log(TTRavg) ~ timepoint + 
                          as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                          (1|crab.ID), 
                        data = modTTRCombined, REML = FALSE) #Null model without population
summary(TTRCombinedNull) #Crab ID doesn't explain any variation!
```

```{r}
TTRPopulation <- lmer(log(TTRavg) ~ timepoint + 
                        as.factor(population) +
                        as.factor(sex) + integument.cont + carapace.width + weight + as.factor(missing.swimmer) + 
                        (1|crab.ID), 
                      data = modTTRCombined, REML = FALSE) #Model with population
anova(TTRCombinedNull, TTRPopulation) #Population is a marginally significant factor. Chisq = 4.6271, p = 0.09891
```

Population has a marginal impact on average TTR.
